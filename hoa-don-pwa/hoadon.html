<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√≥a ƒê∆°n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js');
    });
  }
</script>
    <style>
        * {
            box-sizing: border-box;
        }
        html {
            height: calc(var(--vh, 1vh) * 100);
            color: #444;
        }
        body {
            font-family: Helvetica, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f0f0;
            padding: 10px;
        }
        .container {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .container h3 {
            text-align: center;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #444;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
        }
        button svg {
            fill: white;
            width: 18px;
            height: 18px;
        }
        .invoice {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
        }
        .invoice h2 {
            text-align: center;
        }
        .invoice hr {
            border: none;
            border-top: 1px solid #ddd;
        }
        .items table {
            width: 100%;
            border-collapse: collapse;
        }
        .items th, .items td {
            padding: 5px;
            text-align: center;
        }
        .dashed{
          border-top: 1px dashed #444;
          margin: 8px 0;
        }
        
        #export{
          display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h3>Nh·∫≠p th√¥ng tin h√≥a ƒë∆°n</h3>
        <label for="order-info">üîΩ D√°n th√¥ng tin ƒë∆°n h√†ng:</label>
<textarea id="order-info" rows="6" placeholder="D√°n n·ªôi dung ƒë∆°n h√†ng v√†o ƒë√¢y..."></textarea>
<button onclick="parseOrderInfo()">üìå C·∫≠p nh·∫≠t th√¥ng tin</button>
        <label>T√™n kh√°ch h√†ng:</label>
        <input type="text" id="customerName" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng">
        
        <label>S·ªë ƒëi·ªán tho·∫°i:</label>
        <input type="text" id="customerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">

        <label>ƒê·ªãa ch·ªâ:</label>
        <input type="text" id="customerAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">

        <h3>Th√™m s·∫£n ph·∫©m</h3>
        <label>T√™n s·∫£n ph·∫©m:</label>
        <input type="text" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m">

        <label>Gi√° s·∫£n ph·∫©m:</label>
        <input type="number" id="productPrice" placeholder="Nh·∫≠p gi√° s·∫£n ph·∫©m">

        <label>S·ªë l∆∞·ª£ng:</label>
        <input type="number" id="productQty" value="1" min="1">

        <button onclick="addProduct()">Th√™m s·∫£n ph·∫©m</button>

        <ul id="productList"></ul>

        <label>Ph√≠ v·∫≠n chuy·ªÉn:</label>
        <input type="number" id="shippingFee" value="35000">

        <label>Gi·∫£m gi√°:</label>
        <input type="number" id="discount" placeholder="Nh·∫≠p s·ªë ti·ªÅn ho·∫∑c %">
        <select id="discount-type">
            <option value="amount">VNƒê</option>
            <option value="percent">%</option>
        </select>

        <button onclick="generateInvoice()">T·∫°o h√≥a ƒë∆°n</button>
    </div>

    <div class="invoice" id="invoice">
        <h2>H√ìA ƒê∆†N T·∫†M T√çNH</h2>
        <p style="text-align: center; color: #444;"><strong>M√£ h√≥a ƒë∆°n:</strong> <span id="invoiceCode"></span></p>
        <p><strong style="margin-right: 15px">Kh√°ch:</strong> <span id="displayCustomerName"></span></p>
        <p><strong style="margin-right: 40px">ƒêT:</strong> <span id="displayCustomerPhone"></span></p>
        <p><strong style="margin-right: 12px">ƒê·ªãa ch·ªâ:</strong> <span id="displayCustomerAddress"></span></p>
        <hr>

        <div class="items">
            <table>
                <thead>
                    <tr>
                        <th>S·∫£n ph·∫©m</th>
                        <th>SL</th>
                        <th>Gi√°</th>
                    </tr>
                </thead>
                <tbody id="productListTable"></tbody>
            </table>
        </div>

        <hr>
        <div style="display: flex; justify-content: space-between"><strong>T·∫°m t√≠nh:</strong> <span id="subtotal"></span></div>
        <div style="display: flex; justify-content: space-between"><strong>Ph√≠ v·∫≠n chuy·ªÉn:</strong> <span id="displayShippingFee"></span></div>
        <div style="display: flex; justify-content: space-between"><strong>Gi·∫£m gi√°:</strong> <span id="displayDiscount"></span></div>
        <div class="dashed"></div>
        <div style="display: flex; justify-content: space-between"><strong>T·ªïng c·ªông:</strong> <strong style="text-align: right;" id="total"></strong></div>
    </div>
    </br>
    <button id="export" style="max-width: 200px" onclick="exportToImage()">
        <svg viewBox="0 0 24 24"><path d="M12 16L6 10H10V4H14V10H18L12 16Z"></path><path d="M4 20H20V18H4V20Z"></path></svg> Xu·∫•t H√≥a ƒê∆°n ·∫¢nh
    </button>

    <script>
    function generateInvoice() {
    const customerName = document.getElementById("customerName").value;
    const customerPhone = document.getElementById("customerPhone").value;
    const customerAddress = document.getElementById("customerAddress").value;
    const shippingFee = parseFloat(document.getElementById("shippingFee").value) || 0;
    const discount = parseFloat(document.getElementById("discount").value) || 0;
    const discountType = document.getElementById("discount-type").value;

    let subtotal = 0;
    let productHTML = "";

    products.forEach(product => {
        subtotal += product.price * product.qty;
        productHTML += `<tr>
            <td>${product.name}</td>
            <td>${product.qty}</td>
            <td>${product.price.toLocaleString()} ƒë</td>
        </tr>`;
    });

    let discountAmount = discountType === "percent" ? (subtotal * discount) / 100 : discount;
    let total = subtotal + shippingFee - discountAmount;
    total = total < 0 ? 0 : total;

    document.getElementById("invoiceCode").innerText = Math.random().toString(36).substring(7).toUpperCase();
    document.getElementById("displayCustomerName").innerText = customerName;
    document.getElementById("displayCustomerPhone").innerText = customerPhone;
    document.getElementById("displayCustomerAddress").innerText = customerAddress;
    document.getElementById("productListTable").innerHTML = productHTML;
    document.getElementById("subtotal").innerText = subtotal.toLocaleString() + " ƒë";
    document.getElementById("displayShippingFee").innerText = shippingFee.toLocaleString() + " ƒë";
    document.getElementById("displayDiscount").innerText = "-" + discountAmount.toLocaleString() + " ƒë";
    document.getElementById("total").innerText = total.toLocaleString() + " ƒë";

    document.getElementById("invoice").style.display = "block";
    document.getElementById("export").style.display = "block";
    
}
    
        function adjustHeight() {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        }
        window.addEventListener('resize', adjustHeight);
        adjustHeight();

        document.querySelectorAll('input').forEach((el) => {
            el.addEventListener('focus', () => {
                setTimeout(() => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
        });

        let products = [];

        function addProduct() {
            let name = document.getElementById("productName").value;
            let price = parseFloat(document.getElementById("productPrice").value);
            let qty = parseInt(document.getElementById("productQty").value);

            if (!name || price <= 0 || qty <= 0) {
                alert("Vui l√≤ng nh·∫≠p th√¥ng tin s·∫£n ph·∫©m!");
                return;
            }

            products.push({ name, price, qty });
            let productList = document.getElementById("productList");
            let li = document.createElement("li");
            li.textContent = `${name} - ${price.toLocaleString()} ƒë x${qty}`;
            productList.appendChild(li);

            document.getElementById("productName").value = "";
            document.getElementById("productPrice").value = "";
            document.getElementById("productQty").value = "1";
        }

        function exportToImage() {
            html2canvas(document.getElementById('invoice')).then(canvas => {
                let link = document.createElement('a');
                link.href = canvas.toDataURL();
                link.download = "hoa-don.png";
                link.click();
            });
        }
        
        function parseOrderInfo() {
    const text = document.getElementById("order-info").value;

    // Regex ƒë·ªÉ tr√≠ch xu·∫•t th√¥ng tin
    const orderIdMatch = text.match(/M√£ ƒêH:\s*(\d+)/);
    const receiverMatch = text.match(/Ng∆∞·ªùi nh·∫≠n:\s*([\p{L}\d\s,]+)/u);
    const phoneMatch = text.match(/(\d{10,11})/); 
    const addressMatch = text.match(/ƒê·ªãa ch·ªâ:\s*([\p{L}\d\s\-.]+)/u);
    const deliveryDateMatch = text.match(/D·ª± ki·∫øn giao:\s*(\d{2}\/\d{2}\/\d{4})/);
    const shippingFeeMatch = text.match(/Ng∆∞·ªùi nh·∫≠n tr·∫£ c∆∞·ªõc:\s*([\d.]+)\s*ƒë/);

    // ƒêi·ªÅn v√†o c√°c field c√≥ s·∫µn trong h√≥a ƒë∆°n
    if (orderIdMatch) document.querySelector('[name="order_id"]').value = orderIdMatch[1];
    if (receiverMatch) document.querySelector('[name="receiver_name"]').value = receiverMatch[1].split(",")[0].trim();
    if (phoneMatch) document.querySelector('[name="receiver_phone"]').value = phoneMatch[1];
    if (addressMatch) document.querySelector('[name="receiver_address"]').value = addressMatch[1].trim();
    if (deliveryDateMatch) document.querySelector('[name="delivery_date"]').value = deliveryDateMatch[1];
    if (shippingFeeMatch) document.querySelector('[name="shipping_fee"]').value = shippingFeeMatch[1].replace(/\./g, '');
}
    </script>

</body>
</html>