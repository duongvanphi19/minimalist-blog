<!doctype html>
<html lang="vi">
    <script
        async
        src="https://www.googletagmanager.com/gtag/js?id=G-BCJ7KX3WXT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag("js", new Date());
        gtag("config", "G-BCJ7KX3WXT");
    </script>

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Invoice Generator — Mobile First (Safe Export)</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap"
            rel="stylesheet" />
        <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap"
            rel="stylesheet" />
        <link
            href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
            rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        <style>
            :root {
                --page-bg: #f8f1e7;
                --card-bg: #fff;
                --text: #40342e;
                --muted: #7a6f68;
                --accent: #d4b483;
                --max-width: 980px;
            }
            /* themes */
            .theme-1 {
                --card-bg: #fff;
                --page-bg: #f8f1e7;
                --text: #40342e;
                --accent: #d4b483;
            }
            .theme-2 {
                --card-bg: #fffaf7;
                --page-bg: #f0f7f6;
                --text: #2c3e3a;
                --accent: #7cc6b6;
            }
            .theme-3 {
                --card-bg: #fff;
                --page-bg: #f4f7ff;
                --text: #2e3658;
                --accent: #9aa8ff;
            }
            .theme-4 {
                --card-bg: #fff;
                --page-bg: #fff7f9;
                --text: #3d2b2b;
                --accent: #ffb3c6;
            }
            .theme-5 {
                --card-bg: #fff;
                --page-bg: #fff8e1; /* vàng pastel nhẹ */
                --text: #5d4037; /* nâu nhạt, dễ đọc */
                --accent: #ffc107; /* vàng tươi nổi bật */
            }
            /* Theme 6: Vàng pastel sang trọng */
            /* Theme 6: Xanh đen sang trọng */
            .theme-6 {
                --card-bg: #fff;
                --page-bg: #e3f2fd; /* xanh nhạt nền */
                --text: #0d1b2a; /* xanh đen */
                --accent: #7eb8f3; /* xanh dương đậm */
            }

            /* Theme 7: Tím lavender nhẹ nhàng */
            .theme-7 {
                --card-bg: #fff;
                --page-bg: #f3e5f5; /* tím pastel */
                --text: rgb(15, 1, 24); /* tím đậm */
                --accent: #ba68c8; /* tím lavender nổi */
            }

            /* Theme 8: Cam đào ấm áp */
            .theme-8 {
                --card-bg: #fff;
                --page-bg: #fff3e0; /* cam đào pastel */
                --text: #4e342e; /* nâu đậm */
                --accent: #da6d51; /* cam pastel */
            }

            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
                margin: 0;
                font-family: "Poppins", sans-serif;
                background: var(--page-bg);
                color: var(--text);
            }
            .wrap {
                max-width: var(--max-width);
                margin: 12px auto;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            header {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }
            header h1 {
                font-family: "Playfair Display", serif;
                margin: 0;
                font-size: 24px;
                text-align: center;
                margin-top: 16px;
            }
            header p {
                margin: 0;

                font-size: 13px;
            }

            /* Thêm đoạn CSS này vào file của bạn */
            @keyframes drawUnderline {
                to {
                    transform: scaleX(1);
                }
            }

            header h1 {
                position: relative; /* Quan trọng: để gạch chân có thể định vị */
                display: inline-block; /* Giúp gạch chân chỉ rộng bằng chữ */
                color: var(--text);
            }

            header h1::after {
                content: "";
                position: absolute;
                bottom: -5px;
                left: 0;
                width: 100%;
                height: 3px;
                background: var(--accent);
                transform: scaleX(0); /* Ban đầu không thấy gạch chân */
                transform-origin: bottom left;
                animation: drawUnderline 1.5s cubic-bezier(0.2, 1, 0.3, 1)
                    forwards; /* Áp dụng animation */
                animation-delay: 0.5s; /* Độ trễ 0.5 giây sau khi trang tải */
            }

            /* MOBILE-FIRST layout */
            .main {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .panel {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 12px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            }
            label {
                display: block;
                font-size: 13px;
                color: var(--muted);
                margin-bottom: 6px;
            }
            input[type="text"],
            input[type="number"],
            input[type="date"],
            select,
            input,
            textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #e6e0d8;
                background: transparent;
                font-size: 14px;
                color: var(--text);
                min-width: 0;
            }
            textarea {
                min-height: 70px;
                resize: vertical;
            }
            .row {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .col {
                flex: 1;
                min-width: 120px;
            }
            .swatch.selected {
                border: 2px solid var(--accent);
                box-shadow: 0 0 0 1px #fff;
            }

            .small {
                font-size: 12px;
                color: var(--muted);
            }
            .callout {
                font-weight: 700;
                margin: 8px 0;
            }

            .btn {
                display: inline-block;
                padding: 10px 12px;
                border-radius: 8px;
                border: 0;
                cursor: pointer;
                background: var(--accent);
                color: #fff;
                font-weight: 600;
            }
            .btn.ghost {
                background: transparent;
                border: 1px solid rgba(0, 0, 0, 0.06);
                color: var(--text);
            }
            .btn.warn {
                background: #e86f6f;
            }
            .actions {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-top: 8px;
            }

            /* product list */
            .product-item {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-bottom: 8px;
                flex-wrap: wrap;
            }
            .product-item input {
                flex: 1;
                min-width: 90px;
            }
            .remove-btn {
                background: #e86f6f;
                border: none;
                color: #fff;
                padding: 4px 6px;
                border-radius: 6px;
                cursor: pointer;
            }

            .feature-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                margin: 12px 0px;
            }
            .feature-item {
                background: var(--card-bg);
                padding: 6px 9px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                flex: 1;
                min-width: 200px;
                background: var(--accent);
                font-size: 12px;
                font-weight: 700;
            }
            .feature-item .icon {
                font-size: 14px;
            }

            /* Điều chỉnh lại cho màn hình nhỏ hơn */
            @media (max-width: 600px) {
                .feature-item {
                    min-width: 80%;
                    justify-content: center;
                }
            }

            /* preview */
            .preview-wrap {
                display: flex;
                justify-content: center;
            }
            .card {
                width: 360px;
                background: var(--card-bg);
                border-radius: 14px;
                padding: 16px;
                position: relative;
                box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08);
                overflow: hidden;
            }
            .corner {
                position: absolute;
                opacity: 0.3;
                z-index: 0;
                width: 150px;
            }
            .corner.tl {
                top: -6px;
                left: -6px;
            }
            .corner.br {
                bottom: -6px;
                right: -6px;

                transform: rotate(180deg);
            }
            .logo {
                max-height: 50px;
                display: block;
                margin: 0 auto 6px;
                z-index: 1;
            }
            .shop-name {
                text-align: center;
                font-family: "Playfair Display", serif;
                font-size: 18px;
                margin-bottom: 6px;
                color: var(--text);
            }
            .title {
                text-align: center;
                font-weight: 700;
                color: var(--accent);
                font-size: 12px;
                margin-bottom: 8px;
            }
            .meta {
                font-size: 13px;
                color: var(--text);
                z-index: 1;
                margin-bottom: 8px;
            }
            .meta .row {
                display: flex;
                justify-content: space-between;
                gap: 8px;
            }
            .products {
                background: rgba(255, 255, 255, 0.6);
                padding: 8px;
                border-radius: 8px;
                z-index: 1;
                margin-bottom: 8px;
                min-height: 40px;
            }
            .prod-row {
                display: flex;
                justify-content: space-between;
                font-size: 12px;
                padding: 6px 0;
                border-bottom: 1px dashed rgba(0, 0, 0, 0.04);
            }
            .prod-row:last-child {
                border-bottom: none;
            }
            .total {
                display: flex;
                justify-content: space-between;
                font-weight: 700;
                padding-top: 8px;
                border-top: 1px solid rgba(0, 0, 0, 0.04);
                margin-top: 8px;
            }
            .note {
                text-align: center;
                font-style: italic;
                color: var(--muted);
                font-size: 13px;
                margin-top: 8px;
            }
            .qr {
                display: block;
                margin: 8px auto 0;
                max-width: 140px;
            }
            .footer {
                text-align: center;
                font-size: 16px;
                color: var(--muted);
                margin-top: 8px;
                font-family: "Dancing Script", cursive;
                font-family: "Great Vibes", cursive;
            }

            /* Desktop */
            @media (min-width: 900px) {
                .main {
                    flex-direction: row;
                    gap: 16px;
                }
                .left {
                    flex: 0 0 420px;
                }
                .right {
                    flex: 1;
                    display: flex;
                    align-items: flex-start;
                    justify-content: center;
                }
                .card {
                    width: 420px;
                }
            }
        </style>
    </head>
    <body class="theme-1">
        <div class="wrap">
            <header>
                <h1>Tạo Hóa Đơn Đẹp & Chuyên Nghiệp chỉ trong 30 GIÂY!</h1>
                <p class="small" style="text-align: center">
                    Tùy chỉnh, xem trước trực tiếp, lưu lại và xuất ảnh PNG an
                    toàn ngay trên điện thoại
                </p>
                <p class="callout">
                    "Công cụ tạo hóa đơn hoàn miễn phí, không cần đăng nhập. Bạn
                    có thể dễ dàng tạo, tùy chỉnh và lưu lại mẫu hóa đơn yêu
                    thích ngay trong trình duyệt. Phù hợp cho các shop online,
                    freelancer hay doanh nghiệp nhỏ"
                </p>
                <div class="feature-list">
                    <div class="feature-item">
                        <span class="icon">✨</span>
                        <span>Hoàn toàn miễn phí</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">🔒</span>
                        <span>An toàn & Riêng tư</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">🖌️</span>
                        <span>Tùy chỉnh linh hoạt</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">⚡</span>
                        <span>Xem trước trực tiếp</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">📥</span>
                        <span>Xuất file chất lượng cao</span>
                    </div>
                </div>
            </header>

            <div class="main">
                <div class="left panel">
                    <div
                        id="invoiceForm"
                        style="
                            display: flex;
                            flex-direction: column;
                            gap: 10px;
                        ">
                        <div>
                            <label class="small">Tên shop</label>
                            <input
                                id="shopName"
                                placeholder="Cô Chủ Nhỏ Shop" />
                            <label class="small">Logo (upload)</label>
                            <input id="shopLogo" type="file" accept="image/*" />
                            <div id="shopLogoIndicator" class="upload-indicator"></div>
                        </div>

                        <div>
                            <label class="small">Tên khách</label>
                            <input
                                id="customerName"
                                placeholder="Nguyễn Văn A" />
                            <div class="row" style="margin-top: 6px">
                                <div class="col">
                                    <label class="small">SĐT</label>
                                    <input
                                        id="customerPhone"
                                        placeholder="0909xxxxxx"
                                        type="tel" />
                                </div>
                                <div class="col">
                                    <label class="small">Ngày đặt</label>
                                    <input id="orderDate" type="date" />
                                </div>
                            </div>
                            <label class="small" style="margin-top: 6px"
                                >Địa chỉ nhận</label
                            >
                            <textarea
                                id="customerAddress"
                                placeholder="123 Lê Lợi, Quận 1, TP.HCM"></textarea>
                        </div>

                        <div>
                            <div class="row">
                                <div class="col">
                                    <label class="small">Mã đơn</label>
                                    <input id="orderId" placeholder="DH001" />
                                </div>
                                <div class="col">
                                    <label class="small"
                                        >Ngày nhận dự kiến</label
                                    >
                                    <input id="expectedDate" type="date" />
                                </div>
                            </div>

                            <div class="row" style="margin-top: 6px">
                                <div class="col">
                                    <label class="small">Phương thức</label>
                                    <select id="paymentMethod">
                                        <option>Tiền mặt</option>
                                        <option>Chuyển khoản</option>
                                        <option>COD</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="small">Phí ship (VNĐ)</label>
                                    <input
                                        id="shippingFee"
                                        type="number"
                                        placeholder="0" />
                                </div>
                            </div>

                            <label class="small" style="margin-top: 6px"
                                >Mã giảm / note ngắn</label
                            >
                            <input
                                id="shortNote"
                                placeholder="Voucher / ghi chú ngắn" />
                        </div>

                        <div>
                            <label class="small">Sản phẩm</label>
                            <div id="productList"></div>
                            <div class="actions">
                                <button
                                    id="addProductBtn"
                                    class="btn"
                                    type="button">
                                    + Thêm sản phẩm
                                </button>
                                <button
                                    id="clearProducts"
                                    class="btn ghost"
                                    type="button">
                                    Xóa hết
                                </button>
                            </div>
                            <div class="small" style="margin-top: 8px"></div>
                        </div>

                        <div style="margin-top: 8px">
                            <label class="small">Ghi chú dài (nếu cần)</label>
                            <textarea
                                id="note"
                                placeholder="Ghi chú cho đơn"></textarea>
                        </div>

                        <div style="margin-top: 8px">
                            <label class="small">Ảnh decor góc (PNG)</label>
                            <input
                                id="flowerImage"
                                type="file"
                                accept="image/*" />
                            <div id="flowerImageIndicator" class="upload-indicator"></div>

                            <label class="small" style="margin-top: 6px"
                                >Chọn ảnh decor góc có sẵn</label
                            >
                            <div
                                style="
                                    display: flex;
                                    gap: 8px;
                                    margin-top: 6px;
                                ">
                                <img
                                    class="predefined-flower-img"
                                    src="assets/uploads/flower1.png"
                                    data-image="assets/uploads/flower1.png"
                                    style="
                                        width: 50px;
                                        height: 50px;
                                        cursor: pointer;
                                        border: 2px solid transparent;
                                        border-radius: 4px;
                                    "
                                    alt="Flower 1" />
                                <img
                                    class="predefined-flower-img"
                                    src="assets/uploads/flower2.png"
                                    data-image="assets/uploads/flower2.png"
                                    style="
                                        width: 50px;
                                        height: 50px;
                                        cursor: pointer;
                                        border: 2px solid transparent;
                                        border-radius: 4px;
                                    "
                                    alt="Flower 2" />
                                <img
                                    class="predefined-flower-img"
                                    src="assets/uploads/flower3.png"
                                    data-image="assets/uploads/flower3.png"
                                    style="
                                        width: 50px;
                                        height: 50px;
                                        cursor: pointer;
                                        border: 2px solid transparent;
                                        border-radius: 4px;
                                    "
                                    alt="Flower 3" />
                                <img
                                    class="predefined-flower-img"
                                    src="assets/uploads/flower4.png"
                                    data-image="assets/uploads/flower4.png"
                                    style="
                                        width: 50px;
                                        height: 50px;
                                        cursor: pointer;
                                        border: 2px solid transparent;
                                        border-radius: 4px;
                                    "
                                    alt="Flower 4" />
                                <img
                                    class="predefined-flower-img"
                                    src="assets/uploads/flower5.png"
                                    data-image="assets/uploads/flower5.png"
                                    style="
                                        width: 50px;
                                        height: 50px;
                                        cursor: pointer;
                                        border: 2px solid transparent;
                                        border-radius: 4px;
                                    "
                                    alt="Flower 5" />
                            </div>

                            <label class="small" style="margin-top: 6px"
                                >QR chuyển khoản (upload)</label
                            >
                            <input id="qrImage" type="file" accept="image/*" />
                            <div id="qrImageIndicator" class="upload-indicator"></div>

                            <label class="small" style="margin-top: 6px"
                                >Lời cảm ơn (footer)</label
                            >
                            <input
                                id="thankYouText"
                                placeholder="Cảm ơn anh/chị đã tin tưởng Cô Chủ Nhỏ Shop 🌿" />
                            <div style="margin-top: 8px">
                                <div class="small">Chọn bộ màu</div>
                                <div
                                    style="
                                        display: flex;
                                        gap: 8px;
                                        margin-top: 6px;
                                    ">
                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-1"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fff,
                                                #f6efe6
                                            );
                                            border-radius: 6px;
                                        "></div>
                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-2"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fffaf7,
                                                #e7f6f3
                                            );
                                            border-radius: 6px;
                                        "></div>
                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-3"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fff,
                                                #eef5ff
                                            );
                                            border-radius: 6px;
                                        "></div>
                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-4"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fff,
                                                #fff1f4
                                            );
                                            border-radius: 6px;
                                        "></div>

                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-5"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fff,
                                                #ffc107
                                            );
                                            border-radius: 6px;
                                        "></div>
                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-6"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fff,
                                                 #7eb8f3
                                            );
                                            border-radius: 6px;
                                        "></div>
                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-7"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fff,
                                                #ba68c8
                                            );
                                            border-radius: 6px;
                                        "></div>
                                    <div
                                        class="swatch theme-btn"
                                        data-theme="theme-8"
                                        style="
                                            width: 34px;
                                            height: 24px;
                                            background: linear-gradient(
                                                #fff,
                                                #da6d51
                                            );
                                            border-radius: 6px;
                                        "></div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 10px">
                            <button id="saveBtn" class="btn" type="button">
                                Lưu (local)
                            </button>
                             <button
                                id="clearImagesBtn"
                                class="btn ghost"
                                type="button"
                                style="color:var(--text)">
                                Xóa ảnh đã lưu
                            </button>
                            <button
                                id="resetBtn"
                                class="btn ghost"
                                type="button">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <div class="right panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 8px;
                        ">
                        <div>
                            <strong class="small">Preview</strong>
                        </div>
                        <div class="small"></div>
                    </div>

                    <div class="preview-wrap">
                        <div
                            id="card"
                            class="card"
                            role="img"
                            aria-label="Invoice preview">
                            <img
                                id="flowerTL"
                                class="corner tl"
                                src=""
                                alt=""
                                style="display: none" />
                            <img
                                id="flowerBR"
                                class="corner br"
                                src=""
                                alt=""
                                style="display: none" />
                            <img
                                id="outLogo"
                                class="logo"
                                src=""
                                alt=""
                                style="display: none" />
                            <div class="shop-name" id="outShopName">
                                Cô Chủ Nhỏ Shop
                            </div>
                            <div class="title">XÁC NHẬN ĐƠN HÀNG</div>

                            <div class="meta">
                                <div class="row">
                                    <div>
                                        <strong>Khách:</strong>
                                        <span id="outCustomerName"
                                            >Nguyễn Văn A</span
                                        >
                                    </div>
                                    <div>
                                        <strong>SĐT:</strong>
                                        <span id="outCustomerPhone"
                                            >0909xxxxxx</span
                                        >
                                    </div>
                                </div>
                                <div style="margin-top: 6px">
                                    <strong>Địa chỉ:</strong>
                                    <span id="outCustomerAddress"
                                        >123 Lê Lợi, Q1</span
                                    >
                                    <div style="margin-top: 6px" class="row">
                                        <div>
                                            <strong>Ngày đặt:</strong>
                                            <span id="outOrderDate"
                                                >__/__/____</span
                                            >
                                        </div>
                                        <div>
                                            <strong>Nhận dự kiến:</strong>
                                            <span id="outExpectedDate"
                                                >__/__/____</span
                                            >
                                        </div>
                                    </div>
                                    <div style="margin-top: 6px" class="row">
                                        <div>
                                            <strong>Mã:</strong>
                                            <span id="outOrderId">DH001</span>
                                        </div>
                                        <div>
                                            <strong>Thanh toán:</strong>
                                            <span id="outPaymentMethod"
                                                >Tiền mặt</span
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="products" id="outProducts"></div>

                            <div class="total">
                                <div>Tổng</div>
                                <div id="outTotal">0 ₫</div>
                            </div>

                            <div class="note" id="outShortNote"></div>
                            <img
                                id="outQr"
                                class="qr"
                                src=""
                                alt=""
                                style="display: none" />
                            <div class="footer" id="outThank">
                                Cảm ơn anh/chị đã tin tưởng Shop!
                            </div>
                        </div>
                    </div>

                    <div
                        style="
                            display: flex;
                            gap: 8px;
                            margin-top: 10px;
                            justify-content: center;
                        ">
                        <button id="downloadBtn" class="btn">
                            📥 Tải hóa đơn (PNG)
                        </button>
                    </div>
                </div>
            </div>

            <footer
                style="
                    text-align: center;
                    font-size: 12px;
                    color: var(--muted);
                    margin-top: 6px;
                ">
                <div style="margin-top: 4px; margin-bottom: 24px">
                    <span style="font-style: italic"
                        >Lưu cục bộ trên trình duyệt — Không upload server -
                        Không lo bị lộ thông tin</span
                    >
                </div>
                <div>Được tạo bởi duongvanphi19</div>
                <div style="margin: 0 4px">
                    Nếu bạn thấy hữu ích, hãy ủng hộ một ly cafe nhé!
                    <a
                        href="https://www.buymeacoffee.com/phi19"
                        target="_blank"
                        style="
                            text-decoration: none;
                            display: inline-block;
                            margin-left: 8px;
                        ">
                        <img
                            src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&slug=phi19&button_colour=FFDD00&font_colour=000000&font_family=Poppins&outline_colour=000000&coffee_colour=ffffff"
                            alt="Buy Me A Coffee" />
                    </a>
                </div>
            </footer>
        </div>

        <script>
            /* ======== Helpers ======== */
            const $ = (id) => document.getElementById(id);
            const LS_FORM = "invoice_v3_form";
            const LS_PRODUCTS = "invoice_v3_products";
            const LS_THEME = "invoice_v3_theme";
            const MAX_FILE_SIZE = 1024 * 1024; // 1MB

            // IndexedDB
            const DB_NAME = "InvoiceDB";
            const DB_VERSION = 1;
            const STORE_NAME = "images";
            let db;

            // Bạn có thể tùy chỉnh ảnh decor theo từng tháng tại đây
            const MONTHLY_DECOR_MAP = {
                2: 'assets/uploads/valentine.png', // Tháng 2: Valentine
                3: 'assets/uploads/flower2.png', // Ví dụ tháng 3
                8: 'assets/uploads/flower5.png', // Ví dụ tháng 8
                // Thêm các tháng khác vào đây
            };

            function toCurrency(n) {
                return (Number(n) || 0).toLocaleString("vi-VN");
            }
            function escapeHtml(s) {
                return String(s || "").replace(
                    /[&<>"']/g,
                    (m) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;"
                        })[m]
                );
            }
            
            /* ======== IndexedDB functions ======== */
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (event) => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        reject("IndexedDB error: " + event.target.errorCode);
                    };
                    request.onsuccess = (event) => {
                        db = event.target.result;
                        resolve(db);
                    };
                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: "id" });
                        }
                    };
                });
            }

            function saveImageToDB(id, dataUrl) {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        return reject("IndexedDB not initialized.");
                    }
                    const transaction = db.transaction([STORE_NAME], "readwrite");
                    const store = transaction.objectStore(STORE_NAME);
                    store.put({ id: id, data: dataUrl });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            }
            
            function loadImageFromDB(id) {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        return reject("IndexedDB not initialized.");
                    }
                    const transaction = db.transaction([STORE_NAME], "readonly");
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);

                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        resolve(result ? result.data : null);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            function deleteImagesFromDB() {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        return reject("IndexedDB not initialized.");
                    }
                    const transaction = db.transaction([STORE_NAME], "readwrite");
                    const store = transaction.objectStore(STORE_NAME);
                    store.clear();

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            }

            /* ======== Products ======== */
            function createProductElement(p = {}) {
                const el = document.createElement("div");
                el.className = "product-item";
                el.innerHTML = `
                    <input class="productName" placeholder="Tên sản phẩm" value="${escapeHtml(
                        p.name || ""
                    )}">
                    <input class="productQty" placeholder="SL" type="number" min="0" value="${
                        p.qty || ""
                    }">
                    <input class="productPrice" placeholder="Giá (VNĐ)" type="number" min="0" value="${
                        p.price || ""
                    }">
                    <button class="remove-btn" title="Xóa">×</button>
                `;
                el.querySelector(".remove-btn").addEventListener("click", () => {
                    el.remove();
                    debouncedUpdateInvoice();
                });
                el.querySelectorAll("input").forEach((i) =>
                    i.addEventListener("input", debouncedUpdateInvoice)
                );
                return el;
            }
            function addProduct(p) {
                $("productList").appendChild(createProductElement(p || {}));
                debouncedUpdateInvoice();
            }
            function clearProducts() {
                $("productList").innerHTML = "";
                debouncedUpdateInvoice();
            }
            function getProducts() {
                const nodes = document.querySelectorAll("#productList .product-item");
                const arr = [];
                nodes.forEach((n) => {
                    const name = n.querySelector(".productName").value.trim();
                    const qty = Number(n.querySelector(".productQty").value) || 0;
                    const price = Number(n.querySelector(".productPrice").value) || 0;
                    if (name) arr.push({ name, qty, price });
                });
                return arr;
            }
            function saveProducts() {
                localStorage.setItem(LS_PRODUCTS, JSON.stringify(getProducts()));
            }

            /* ======== Form save/load ======== */
            function saveForm() {
                const ids = [
                    "shopName",
                    "customerName",
                    "customerPhone",
                    "customerAddress",
                    "orderDate",
                    "expectedDate",
                    "orderId",
                    "paymentMethod",
                    "shippingFee",
                    "shortNote",
                    "note",
                    "thankYouText"
                ];
                const data = {};
                ids.forEach((id) => {
                    const el = $(id);
                    if (el) data[id] = el.value;
                });
                localStorage.setItem(LS_FORM, JSON.stringify(data));
            }
            function loadForm() {
                const data = JSON.parse(localStorage.getItem(LS_FORM) || "{}");
                if (!data) return;
                Object.keys(data).forEach((k) => {
                    if ($(k)) $(k).value = data[k];
                });
            }

            /* ======== Images save/load (IndexedDB) ======== */
            async function handleImageUpload(inputId, outIds, storageKey) {
                const input = $(inputId);
                if (!input) return;

                const indicator = $(`${inputId}Indicator`);

                input.addEventListener("change", async (e) => {
                    indicator.textContent = '';
                    indicator.className = 'upload-indicator';
                    
                    const f = e.target.files[0];
                    if (!f) {
                        indicator.style.display = 'none';
                        return;
                    }
                    
                    indicator.textContent = 'Đang tải...';
                    indicator.className = 'upload-indicator loading';
                    indicator.style.display = 'block';

                    if (f.size > MAX_FILE_SIZE) {
                        indicator.textContent = `Lỗi: File quá lớn (> 1MB). Vui lòng chọn file khác.`;
                        indicator.className = 'upload-indicator error';
                        input.value = '';
                        return;
                    }

                    try {
                        const data = await new Promise((res, rej) => {
                            const r = new FileReader();
                            r.onload = (e) => res(e.target.result);
                            r.onerror = rej;
                            r.readAsDataURL(f);
                        });
                        
                        await saveImageToDB(storageKey, data);

                        outIds.forEach((id) => {
                            if ($(id)) {
                                $(id).src = data;
                                $(id).style.display = "block";
                            }
                        });

                        indicator.textContent = 'Tải lên thành công!';
                        indicator.className = 'upload-indicator success';
                        setTimeout(() => {
                            indicator.style.display = 'none';
                        }, 3000);

                        if (storageKey === "flowerImg") {
                            document
                                .querySelectorAll(".predefined-flower-img")
                                .forEach((img) => {
                                    img.style.border = "2px solid transparent";
                                });
                        }
                    } catch (error) {
                        console.error("Lỗi khi tải file:", error);
                        indicator.textContent = 'Lỗi khi tải file. Vui lòng thử lại.';
                        indicator.className = 'upload-indicator error';
                        input.value = '';
                    }
                });
            }

            async function setMonthlyDecor() {
                const currentMonth = new Date().getMonth() + 1; // getMonth() is 0-indexed
                const monthlyImagePath = MONTHLY_DECOR_MAP[currentMonth];
                
                if (monthlyImagePath) {
                    const savedImage = await loadImageFromDB('flowerImg');
                    // Chỉ cập nhật nếu người dùng chưa tự chọn ảnh khác
                    if (!savedImage || savedImage.startsWith('assets/uploads/flower')) {
                        await saveImageToDB('flowerImg', monthlyImagePath);
                    }
                }
            }

            async function loadImages() {
                const imgs = {};
                imgs.shopLogo = await loadImageFromDB('shopLogo');
                imgs.flowerImg = await loadImageFromDB('flowerImg');
                imgs.qrImg = await loadImageFromDB('qrImg');
                
                // Xử lý logo
                if (imgs.shopLogo && $("outLogo")) {
                    $("outLogo").src = imgs.shopLogo;
                    $("outLogo").style.display = "block";
                } else if ($("outLogo")) {
                    $("outLogo").style.display = "none";
                }

                // Xử lý ảnh decor góc
                if (imgs.flowerImg) {
                    if ($("flowerTL")) {
                        $("flowerTL").src = imgs.flowerImg;
                        $("flowerTL").style.display = "block";
                    }
                    if ($("flowerBR")) {
                        $("flowerBR").src = imgs.flowerImg;
                        $("flowerBR").style.display = "block";
                    }
                    document
                        .querySelectorAll(".predefined-flower-img")
                        .forEach((img) => {
                            if (img.getAttribute("data-image") === imgs.flowerImg) {
                                img.style.border = "2px solid var(--accent)";
                            } else {
                                img.style.border = "2px solid transparent";
                            }
                        });
                } else {
                    if ($("flowerTL")) $("flowerTL").style.display = "none";
                    if ($("flowerBR")) $("flowerBR").style.display = "none";
                    document
                        .querySelectorAll(".predefined-flower-img")
                        .forEach((img) => {
                            img.style.border = "2px solid transparent";
                        });
                }

                // Xử lý QR Code
                if (imgs.qrImg && $("outQr")) {
                    $("outQr").src = imgs.qrImg;
                    $("outQr").style.display = "block";
                } else if ($("outQr")) {
                    $("outQr").style.display = "none";
                }

                // Ẩn tất cả các indicator khi tải lại trang
                document.querySelectorAll('.upload-indicator').forEach(ind => ind.style.display = 'none');
            }

            /* ======== Theme ======== */
            function setTheme(cls) {
                document.body.classList.remove(
                    "theme-1",
                    "theme-2",
                    "theme-3",
                    "theme-4",
                    "theme-5",
                    "theme-6",
                    "theme-7",
                    "theme-8"
                );
                document.body.classList.add(cls);
                localStorage.setItem(LS_THEME, cls);
            }
            function loadTheme() {
                const t = localStorage.getItem(LS_THEME) || "theme-1";
                setTheme(t);
                document.querySelectorAll(".theme-btn").forEach((b) => {
                    if (b.dataset.theme === t) b.classList.add("selected");
                    else b.classList.remove("selected");
                });
            }

            /* ======== Debounced Update ======== */
            let updateTimeout = null;
            function debouncedUpdateInvoice() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateInvoice();
                    saveForm();
                    saveProducts();
                }, 300);
            }

            /* ======== Update preview ======== */
            function updateInvoice() {
                $("outShopName").innerText =
                    $("shopName").value.trim() || "Cô Chủ Nhỏ Shop";
                $("outCustomerName").innerText =
                    $("customerName").value.trim() || "Tên khách hàng";
                $("outCustomerPhone").innerText =
                    $("customerPhone").value.trim() || "SĐT";
                $("outCustomerAddress").innerText =
                    $("customerAddress").value.trim() || "Địa chỉ nhận";
                $("outOrderDate").innerText =
                    $("orderDate").value || "__/__/____";
                $("outExpectedDate").innerText =
                    $("expectedDate").value || "__/__/____";
                $("outOrderId").innerText =
                    $("orderId").value.trim() || "Mã đơn";
                $("outPaymentMethod").innerText =
                    $("paymentMethod").value || "Tiền mặt";
                $("outShortNote").innerText = $("shortNote").value.trim() || "";
                $("outThank").innerText =
                    $("thankYouText").value.trim() ||
                    "Cảm ơn anh/chị đã tin tưởng ủng hộ Cô Chủ Nhỏ Shop!";

                const prods = getProducts();
                const out = $("outProducts");
                out.innerHTML = "";
                let total = 0;
                if (prods.length === 0) {
                    out.innerHTML =
                        '<div style="text-align:center;color:var(--muted);padding:8px">Không có sản phẩm</div>';
                } else {
                    const frag = document.createDocumentFragment();
                    const row = document.createElement("div");
                    row.className = "callout prod-row";
                    row.style = "color: var(--accent)";
                    row.innerHTML = `<div style="flex:1">
                            Sản phẩm
                        </div><div style="width:24px;text-align:right">
                            SL
                        </div><div style="width:90px;text-align:right">
                            Đơn giá
                        </div><div style="width:90px;text-align:right">
                            Thành tiền
                        </div>`;
                    frag.appendChild(row);
                    prods.forEach((p) => {
                        const subtotal = p.qty * p.price;
                        total += subtotal;
                        const row = document.createElement("div");
                        row.className = "prod-row";
                        row.innerHTML = `<div style="flex:1">${escapeHtml(
                            p.name
                        )}</div><div style="width:24px;text-align:right">${
                            p.qty
                        }</div><div style="width:90px;text-align:right">${toCurrency(
                            p.price
                        )} ₫</div><div style="width:90px;text-align:right">${toCurrency(
                            subtotal
                        )} ₫</div>`;
                        frag.appendChild(row);
                    });
                    out.appendChild(frag);
                }
                const shipping = Number($("shippingFee").value) || 0;
                if (shipping > 0) {
                    const r = document.createElement("div");
                    r.className = "prod-row";
                    r.innerHTML = `<div style="flex:1">Phí ship</div><div style="width:36px"></div><div style="width:90px;text-align:right"></div><div style="width:110px;text-align:right">${toCurrency(
                        shipping
                    )} ₫</div>`;
                    out.appendChild(r);
                    total += shipping;
                }
                $("outTotal").innerText = toCurrency(total) + " ₫";
            }

            /* ======== Save/load products & form on start ======== */
            function loadProducts() {
                const arr = JSON.parse(
                    localStorage.getItem(LS_PRODUCTS) || "[]"
                );
                $("productList").innerHTML = "";
                if (!arr || arr.length === 0) {
                    addProduct({
                        name: "B.Begin Non-Alcohol Perfume",
                        qty: 1,
                        price: 1200000
                    });
                } else arr.forEach((p) => addProduct(p));
            }

            /* ======== Events init ======== */
            document.addEventListener("DOMContentLoaded", async () => {
                // Init IndexedDB
                await initDB();

                // load saved
                loadForm();
                await setMonthlyDecor();
                loadProducts();
                await loadImages();
                loadTheme();
                updateInvoice();

                // input live update
                document
                    .querySelectorAll(
                        '#invoiceForm input:not([type="file"]), #invoiceForm textarea, #invoiceForm select'
                    )
                    .forEach((inp) =>
                        inp.addEventListener("input", debouncedUpdateInvoice)
                    );

                // file uploads (store in IndexedDB)
                handleImageUpload("shopLogo", ["outLogo"], "shopLogo");
                handleImageUpload(
                    "flowerImage",
                    ["flowerTL", "flowerBR"],
                    "flowerImg"
                );
                handleImageUpload("qrImage", ["outQr"], "qrImg");

                // add/clear product
                $("addProductBtn").addEventListener("click", () => {
                    addProduct({});
                });
                $("clearProducts").addEventListener("click", () => {
                    if (confirm("Xóa hết sản phẩm?")) {
                        clearProducts();
                    }
                });

                // save/reset
                $("saveBtn").addEventListener("click", () => {
                    try {
                        saveForm();
                        saveProducts();
                        alert("Đã lưu dữ liệu vào trình duyệt.");
                    } catch (e) {
                        console.error(e);
                        alert("Lỗi khi lưu dữ liệu. Vui lòng thử lại.");
                    }
                });
                
                $("clearImagesBtn").addEventListener("click", async () => {
                    if (confirm("Bạn có chắc chắn muốn xóa toàn bộ ảnh (logo, decor, QR) đã lưu không?")) {
                        try {
                            await deleteImagesFromDB();
                            // Lưu lại ảnh decor mặc định nếu đang là tháng có decor
                            await setMonthlyDecor(); 
                            await loadImages();
                            alert("Đã xóa toàn bộ ảnh đã lưu.");
                        } catch (e) {
                            console.error("Lỗi khi xóa ảnh:", e);
                            alert("Có lỗi xảy ra khi xóa ảnh. Vui lòng thử lại.");
                        }
                    }
                });
                
                $("resetBtn").addEventListener("click", () => {
                    if (confirm("Reset toàn bộ dữ liệu?")) {
                        localStorage.clear();
                        location.reload();
                    }
                });

                // theme buttons
                document.querySelectorAll(".theme-btn").forEach((btn) =>
                    btn.addEventListener("click", () => {
                        setTheme(btn.dataset.theme);
                        btn.classList.add("selected");
                        document.querySelectorAll(".theme-btn").forEach((b) => {
                            if (b !== btn) b.classList.remove("selected");
                        });
                    })
                );

                // Predefined flower images
                document
                    .querySelectorAll(".predefined-flower-img")
                    .forEach((btn) => {
                        btn.addEventListener("click", async () => {
                            const imagePath = btn.getAttribute("data-image");
                            await saveImageToDB('flowerImg', imagePath);
                            loadImages();
                            updateInvoice();
                        });
                    });

                // download (safe)
                $("downloadBtn").addEventListener("click", async () => {
                    const btn = $("downloadBtn");
                    btn.disabled = true;
                    btn.textContent = "Đang tạo ảnh...";
                    try {
                        // wait images inside card to load (logo/flower/qr)
                        const imgs = Array.from(
                            document.querySelectorAll("#card img")
                        );
                        await Promise.all(
                            imgs.map(
                                (img) =>
                                    new Promise((resolve) => {
                                        if (!img.src) return resolve();
                                        if (img.complete) return resolve();
                                        img.onload = () => resolve();
                                        img.onerror = () => {
                                            console.error('Lỗi khi tải ảnh:', img.src);
                                            resolve();
                                        };
                                    })
                            )
                        );

                        // compute safe scale: don't exceed 3 to avoid memory spikes
                        const card = $("card");
                        const origWidth = card.clientWidth || 360;
                        const targetWidth = 1080;
                        let scale = Math.min(
                            3,
                            Math.max(1.5, targetWidth / origWidth)
                        );
                        // render with html2canvas
                        const canvas = await html2canvas(card, {
                            useCORS: true,
                            scale: scale,
                            backgroundColor: null
                        });
                        // export via blob to avoid huge dataURL memory peak
                        canvas.toBlob(
                            (blob) => {
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement("a");
                                a.href = url;
                                a.download = `invoice_${
                                    $("orderId").value || "order"
                                }.png`;
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                setTimeout(
                                    () => URL.revokeObjectURL(url),
                                    10000
                                );
                            },
                            "image/png",
                            0.95
                        );
                    } catch (err) {
                        console.error(err);
                        alert("Có lỗi khi tạo ảnh. Thử lại nhé.");
                    } finally {
                        btn.disabled = false;
                        btn.textContent = "📥 Tải hóa đơn (PNG)";
                    }
                });
            }); // end DOMContentLoaded
        </script>
    </body>
</html>
