<!doctype html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Invoice Generator ‚Äî Mobile First (Safe Export)</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap"
            rel="stylesheet" />
        <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap"
            rel="stylesheet" />
        <link
            href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
            rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        <style>
            :root {
                --page-bg: #f8f1e7;
                --card-bg: #fff;
                --text: #40342e;
                --muted: #7a6f68;
                --accent: #d4b483;
                --max-width: 980px;
            }
            /* themes */
            .theme-1 {
                --card-bg: #fff;
                --page-bg: #f8f1e7;
                --text: #40342e;
                --accent: #d4b483;
            }
            .theme-2 {
                --card-bg: #fffaf7;
                --page-bg: #f0f7f6;
                --text: #2c3e3a;
                --accent: #7cc6b6;
            }
            .theme-3 {
                --card-bg: #fff;
                --page-bg: #f4f7ff;
                --text: #2e3658;
                --accent: #9aa8ff;
            }
            .theme-4 {
                --card-bg: #fff;
                --page-bg: #fff7f9;
                --text: #3d2b2b;
                --accent: #ffb3c6;
            }

            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
                margin: 0;
                font-family: "Poppins", sans-serif;
                background: var(--page-bg);
                color: var(--text);
            }
            .wrap {
                max-width: var(--max-width);
                margin: 12px auto;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            header {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }
            header h1 {
                font-family: "Playfair Display", serif;
                margin: 0;
                font-size: 24px;
                text-align: center;
                margin-top: 16px;
            }
            header p {
                margin: 0;

                font-size: 13px;
            }

            /* MOBILE-FIRST layout */
            .main {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .panel {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 12px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            }
            label {
                display: block;
                font-size: 13px;
                color: var(--muted);
                margin-bottom: 6px;
            }
            input[type="text"],
            input[type="number"],
            input[type="date"],
            select,
            input,
            textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #e6e0d8;
                background: transparent;
                font-size: 14px;
                color: var(--text);
                min-width: 0;
            }
            textarea {
                min-height: 70px;
                resize: vertical;
            }
            .row {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .col {
                flex: 1;
                min-width: 120px;
            }
            .swatch.selected {
                border: 2px solid var(--accent);
                box-shadow: 0 0 0 1px #fff;
            }

            .small {
                font-size: 12px;
                color: var(--muted);
            }
            .callout {
                font-weight: 700;
                margin: 8px 0;
            }

            .btn {
                display: inline-block;
                padding: 10px 12px;
                border-radius: 8px;
                border: 0;
                cursor: pointer;
                background: var(--accent);
                color: #fff;
                font-weight: 600;
            }
            .btn.ghost {
                background: transparent;
                border: 1px solid rgba(0, 0, 0, 0.06);
                color: var(--text);
            }
            .btn.warn {
                background: #e86f6f;
            }
            .actions {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-top: 8px;
            }

            /* product list */
            .product-item {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-bottom: 8px;
                flex-wrap: wrap;
            }
            .product-item input {
                flex: 1;
                min-width: 90px;
            }
            .remove-btn {
                background: #e86f6f;
                border: none;
                color: #fff;
                padding: 4px 6px;
                border-radius: 6px;
                cursor: pointer;
            }

            .feature-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                margin: 12px 0px;
            }
            .feature-item {
                background: var(--card-bg);
                padding: 6px 9px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                flex: 1;
                min-width: 200px;
                background: var(--accent);
                font-size: 12px;
                font-weight: 700;
            }
            .feature-item .icon {
                font-size: 14px;
            }

            /* ƒêi·ªÅu ch·ªânh l·∫°i cho m√†n h√¨nh nh·ªè h∆°n */
            @media (max-width: 600px) {
                .feature-item {
                    min-width: 80%;
                    justify-content: center;
                }
            }

            /* preview */
            .preview-wrap {
                display: flex;
                justify-content: center;
            }
            .history-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.history-list-item:last-child {
    border-bottom: none;
}
.history-list-item button {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 6px;
}

            .card {
                width: 360px;
                background: var(--card-bg);
                border-radius: 14px;
                padding: 16px;
                position: relative;
                box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08);
                overflow: hidden;
            }
            .corner {
                position: absolute;
                opacity: 0.22;
                z-index: 0;
                width: 150px;
            }
            .corner.tl {
                top: -6px;
                left: -6px;
            }
            .corner.br {
                bottom: -6px;
                right: -6px;

                transform: rotate(180deg);
            }
            .logo {
                max-height: 50px;
                display: block;
                margin: 0 auto 6px;
                z-index: 1;
            }
            .shop-name {
                text-align: center;
                font-family: "Playfair Display", serif;
                font-size: 18px;
                margin-bottom: 6px;
                color: var(--text);
            }
            .title {
                text-align: center;
                font-weight: 700;
                color: var(--accent);
                font-size: 12px;
                margin-bottom: 8px;
            }
            .meta {
                font-size: 13px;
                color: var(--text);
                z-index: 1;
                margin-bottom: 8px;
            }
            .meta .row {
                display: flex;
                justify-content: space-between;
                gap: 8px;
            }
            .products {
                background: rgba(255, 255, 255, 0.6);
                padding: 8px;
                border-radius: 8px;
                z-index: 1;
                margin-bottom: 8px;
                min-height: 40px;
            }
            .prod-row {
                display: flex;
                justify-content: space-between;
                font-size: 12px;
                padding: 6px 0;
                border-bottom: 1px dashed rgba(0, 0, 0, 0.04);
            }
            .prod-row:last-child {
                border-bottom: none;
            }
            .total {
                display: flex;
                justify-content: space-between;
                font-weight: 700;
                padding-top: 8px;
                border-top: 1px solid rgba(0, 0, 0, 0.04);
                margin-top: 8px;
            }
            .note {
                text-align: center;
                font-style: italic;
                color: var(--muted);
                font-size: 13px;
                margin-top: 8px;
            }
            .qr {
                display: block;
                margin: 8px auto 0;
                max-width: 140px;
            }
            .footer {
                text-align: center;
                font-size: 16px;
                color: var(--muted);
                margin-top: 8px;
                font-family: "Dancing Script", cursive;
            }

            /* Desktop */
            @media (min-width: 900px) {
                .main {
                    flex-direction: row;
                    gap: 16px;
                }
                .left {
                    flex: 0 0 420px;
                }
                .right {
                    flex: 1;
                    display: flex;
                    align-items: flex-start;
                    justify-content: center;
                }
                .card {
                    width: 420px;
                }
            }
        </style>
    </head>
    <body class="theme-1">
        <div class="wrap">
            <header>
                <h1>T·∫°o H√≥a ƒê∆°n ƒê·∫πp & Chuy√™n Nghi·ªáp ch·ªâ trong 30 gi√¢y</h1>
                <p class="small" style="text-align: center">
                    T√πy ch·ªânh, xem tr∆∞·ªõc tr·ª±c ti·∫øp, l∆∞u l·∫°i v√† xu·∫•t ·∫£nh PNG an
                    to√†n ngay tr√™n ƒëi·ªán tho·∫°i
                </p>
                <p class="callout">
                    "C√¥ng c·ª• t·∫°o h√≥a ƒë∆°n ho√†n mi·ªÖn ph√≠, kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p. B·∫°n
                    c√≥ th·ªÉ d·ªÖ d√†ng t·∫°o, t√πy ch·ªânh v√† l∆∞u l·∫°i m·∫´u h√≥a ƒë∆°n y√™u
                    th√≠ch ngay trong tr√¨nh duy·ªát. Ph√π h·ª£p cho c√°c shop online,
                    freelancer hay doanh nghi·ªáp nh·ªè"
                </p>
                <div class="feature-list">
                    <div class="feature-item">
                        <span class="icon">‚ú®</span>
                        <span>Ho√†n to√†n mi·ªÖn ph√≠</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">üîí</span>
                        <span>An to√†n & Ri√™ng t∆∞</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">üñåÔ∏è</span>
                        <span>T√πy ch·ªânh linh ho·∫°t</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">‚ö°</span>
                        <span>Xem tr∆∞·ªõc tr·ª±c ti·∫øp</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">üì•</span>
                        <span>Xu·∫•t file ch·∫•t l∆∞·ª£ng cao</span>
                    </div>
                </div>
            </header>

            <div class="main">
    <div class="left panel">
        <div id="invoiceForm" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="text-align: center">
                <strong class="small">T·∫°o h√≥a ƒë∆°n m·ªõi</strong>
                <p class="small">
                    ƒêi·ªÅn th√¥ng tin v√†o form b√™n d∆∞·ªõi ƒë·ªÉ t·∫°o h√≥a ƒë∆°n c·ªßa b·∫°n.
                </p>
            </div>
            <div>
                <label class="small">T√™n shop</label>
                <input id="shopName" placeholder="Di·ªÖm Th√∫y Shop" />
                <label class="small">Logo (upload)</label>
                <input id="shopLogo" type="file" accept="image/*" />
            </div>
            <div>
                <label class="small">T√™n kh√°ch</label>
                <input id="customerName" placeholder="Nguy·ªÖn VƒÉn A" />
                <div class="row" style="margin-top: 6px">
                    <div class="col">
                        <label class="small">SƒêT</label>
                        <input id="customerPhone" placeholder="0909xxxxxx" />
                    </div>
                    <div class="col">
                        <label class="small">Ng√†y ƒë·∫∑t</label>
                        <input id="orderDate" type="date" />
                    </div>
                </div>
                <label class="small" style="margin-top: 6px">ƒê·ªãa ch·ªâ nh·∫≠n</label>
                <textarea id="customerAddress" placeholder="123 L√™ L·ª£i, Qu·∫≠n 1, TP.HCM"></textarea>
            </div>
            <div>
                <div class="row">
                    <div class="col">
                        <label class="small">M√£ ƒë∆°n</label>
                        <input id="orderId" placeholder="DH001" />
                    </div>
                    <div class="col">
                        <label class="small">Ng√†y nh·∫≠n d·ª± ki·∫øn</label>
                        <input id="expectedDate" type="date" />
                    </div>
                </div>
                <div class="row" style="margin-top: 6px">
                    <div class="col">
                        <label class="small">Ph∆∞∆°ng th·ª©c</label>
                        <select id="paymentMethod">
                            <option>Ti·ªÅn m·∫∑t</option>
                            <option>Chuy·ªÉn kho·∫£n</option>
                            <option>COD</option>
                        </select>
                    </div>
                    <div class="col">
                        <label class="small">Ph√≠ ship (VNƒê)</label>
                        <input id="shippingFee" type="number" placeholder="0" />
                    </div>
                </div>
                <label class="small" style="margin-top: 6px">M√£ gi·∫£m / note ng·∫Øn</label>
                <input id="shortNote" placeholder="Voucher / ghi ch√∫ ng·∫Øn" />
            </div>
            <div>
                <label class="small">S·∫£n ph·∫©m</label>
                <div id="productList"></div>
                <div class="actions">
                    <button id="addProductBtn" class="btn" type="button">
                        + Th√™m s·∫£n ph·∫©m
                    </button>
                    <button id="clearProducts" class="btn ghost" type="button">
                        X√≥a h·∫øt
                    </button>
                </div>
                <div class="small" style="margin-top: 8px"></div>
            </div>
            <div style="margin-top: 8px">
                <label class="small">Ghi ch√∫ d√†i (n·∫øu c·∫ßn)</label>
                <textarea id="note" placeholder="Ghi ch√∫ cho ƒë∆°n"></textarea>
            </div>
            <div style="margin-top: 8px">
                <label class="small">·∫¢nh hoa g√≥c (PNG)</label>
                <input id="flowerImage" type="file" accept="image/*" />
                <label class="small" style="margin-top: 6px">QR chuy·ªÉn kho·∫£n (upload)</label>
                <input id="qrImage" type="file" accept="image/*" />
                <label class="small" style="margin-top: 6px">L·ªùi c·∫£m ∆°n (footer)</label>
                <input id="thankYouText" placeholder="C·∫£m ∆°n anh/ch·ªã ƒë√£ tin t∆∞·ªüng Di·ªÖm Th√∫y Shop üåø" />
                <div style="margin-top: 8px">
                    <div class="small">Ch·ªçn b·ªô m√†u</div>
                    <div style="display: flex; gap: 8px; margin-top: 6px;">
                        <div class="swatch theme-btn" data-theme="theme-1" style="width: 34px; height: 24px; background: linear-gradient(#fff, #f6efe6); border-radius: 6px;"></div>
                        <div class="swatch theme-btn" data-theme="theme-2" style="width: 34px; height: 24px; background: linear-gradient(#fffaf7, #e7f6f3); border-radius: 6px;"></div>
                        <div class="swatch theme-btn" data-theme="theme-3" style="width: 34px; height: 24px; background: linear-gradient(#fff, #eef5ff); border-radius: 6px;"></div>
                        <div class="swatch theme-btn" data-theme="theme-4" style="width: 34px; height: 24px; background: linear-gradient(#fff, #fff1f4); border-radius: 6px;"></div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button id="saveBtn" class="btn" type="button">
                    L∆∞u h√≥a ƒë∆°n
                </button>
                <button id="resetBtn" class="btn ghost" type="button">
                    Reset
                </button>
            </div>
        </div>
    </div>
    <div class="right panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div>
                <strong class="small">Preview</strong>
            </div>
        </div>
        <div class="preview-wrap">
            <div id="card" class="card" role="img" aria-label="Invoice preview">
                <img id="flowerTL" class="corner tl" src="" alt="" style="display: none" />
                <img id="flowerBR" class="corner br" src="" alt="" style="display: none" />
                <img id="outLogo" class="logo" src="" alt="" style="display: none" />
                <div class="shop-name" id="outShopName">
                    Di·ªÖm Th√∫y Shop
                </div>
                <div class="title">X√ÅC NH·∫¨N ƒê∆†N H√ÄNG</div>
                <div class="meta">
                    <div class="row">
                        <div>
                            <strong>Kh√°ch:</strong>
                            <span id="outCustomerName">Nguy·ªÖn VƒÉn A</span>
                        </div>
                        <div>
                            <strong>SƒêT:</strong>
                            <span id="outCustomerPhone">0909xxxxxx</span>
                        </div>
                    </div>
                    <div style="margin-top: 6px">
                        <strong>ƒê·ªãa ch·ªâ:</strong>
                        <span id="outCustomerAddress">123 L√™ L·ª£i, Q1</span>
                    </div>
                    <div style="margin-top: 6px" class="row">
                        <div>
                            <strong>Ng√†y ƒë·∫∑t:</strong>
                            <span id="outOrderDate">__/__/____</span>
                        </div>
                        <div>
                            <strong>Nh·∫≠n d·ª± ki·∫øn:</strong>
                            <span id="outExpectedDate">__/__/____</span>
                        </div>
                    </div>
                    <div style="margin-top: 6px" class="row">
                        <div>
                            <strong>M√£:</strong>
                            <span id="outOrderId">DH001</span>
                        </div>
                        <div>
                            <strong>Thanh to√°n:</strong>
                            <span id="outPaymentMethod">Ti·ªÅn m·∫∑t</span>
                        </div>
                    </div>
                </div>
                <div class="products" id="outProducts"></div>
                <div class="total">
                    <div>T·ªïng</div>
                    <div id="outTotal">0 ‚Ç´</div>
                </div>
                <div class="note" id="outShortNote"></div>
                <img id="outQr" class="qr" src="" alt="" style="display: none" />
                <div class="footer" id="outThank">
                    C·∫£m ∆°n anh/ch·ªã ƒë√£ tin t∆∞·ªüng Di·ªÖm Th√∫y Shop!
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px; justify-content: center;">
            <button id="downloadBtn" class="btn">
                üì• T·∫£i h√≥a ƒë∆°n (PNG)
            </button>
        </div>
    </div>
</div>

<div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong class="small">H√≥a ƒë∆°n ƒë√£ l∆∞u</strong>
        <button id="clearAllHistoryBtn" class="btn warn" type="button">X√≥a t·∫•t c·∫£</button>
    </div>
    <div id="invoiceHistoryList" style="margin-top: 12px">
        <div style="text-align: center; color: var(--muted)">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o ƒë∆∞·ª£c l∆∞u.</div>
    </div>
</div>


            <footer
                style="
                    text-align: center;
                    font-size: 12px;
                    color: var(--muted);
                    margin-top: 6px;
                ">
                L∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát ‚Äî Kh√¥ng upload server - Kh√¥ng lo b·ªã
                l·ªô th√¥ng tin
            </footer>
        </div>

        <script>
            /* ======== Helpers ======== */
            const $ = (id) => document.getElementById(id);
            const LS_FORM = "invoice_v3_form";
            const LS_PRODUCTS = "invoice_v3_products";
            const LS_IMAGES = "invoice_v3_images";
            const LS_THEME = "invoice_v3_theme";

            function toCurrency(n) {
                return (Number(n) || 0).toLocaleString("vi-VN");
            }
            function dataURLFromFile(file) {
                return new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = (e) => res(e.target.result);
                    r.onerror = rej;
                    r.readAsDataURL(file);
                });
            }
            function escapeHtml(s) {
                return String(s || "").replace(
                    /[&<>"']/g,
                    (m) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;"
                        })[m]
                );
            }

            /* ======== Products ======== */
            function createProductElement(p = {}) {
                const el = document.createElement("div");
                el.className = "product-item";
                el.innerHTML = `
                    <input class="productName" placeholder="T√™n s·∫£n ph·∫©m" value="${escapeHtml(
                        p.name || ""
                    )}">
                    <input class="productQty" placeholder="SL" type="number" min="0" value="${
                        p.qty || ""
                    }">
                    <input class="productPrice" placeholder="Gi√° (VNƒê)" type="number" min="0" value="${
                        p.price || ""
                    }">
                    <button class="remove-btn" title="X√≥a">√ó</button>
                `;
                el.querySelector(".remove-btn").addEventListener(
                    "click",
                    () => {
                        el.remove();
                        debouncedUpdateInvoice();
                    }
                );
                el.querySelectorAll("input").forEach((i) =>
                    i.addEventListener("input", debouncedUpdateInvoice)
                );
                return el;
            }
            function addProduct(p) {
                $("productList").appendChild(createProductElement(p || {}));
                debouncedUpdateInvoice();
            }
            function clearProducts() {
                $("productList").innerHTML = "";
                debouncedUpdateInvoice();
            }
            function getProducts() {
                const nodes = document.querySelectorAll(
                    "#productList .product-item"
                );
                const arr = [];
                nodes.forEach((n) => {
                    const name = n.querySelector(".productName").value.trim();
                    const qty =
                        Number(n.querySelector(".productQty").value) || 0;
                    const price =
                        Number(n.querySelector(".productPrice").value) || 0;
                    if (name) arr.push({ name, qty, price });
                });
                return arr;
            }
            function saveProducts() {
                localStorage.setItem(
                    LS_PRODUCTS,
                    JSON.stringify(getProducts())
                );
            }

            /* ======== Form save/load ======== */
            function saveForm() {
                const ids = [
                    "shopName",
                    "customerName",
                    "customerPhone",
                    "customerAddress",
                    "orderDate",
                    "expectedDate",
                    "orderId",
                    "paymentMethod",
                    "shippingFee",
                    "shortNote",
                    "note",
                    "thankYouText"
                ];
                const data = {};
                ids.forEach((id) => {
                    const el = $(id);
                    if (el) data[id] = el.value;
                });
                localStorage.setItem(LS_FORM, JSON.stringify(data));
            }
            function loadForm() {
                const data = JSON.parse(localStorage.getItem(LS_FORM) || "{}");
                if (!data) return;
                Object.keys(data).forEach((k) => {
                    if ($(k)) $(k).value = data[k];
                });
            }

            /* ======== Images save/load (base64) ======== */
            async function handleImageUpload(inputId, outIds, storageKey) {
                const input = $(inputId);
                if (!input) return;
                input.addEventListener("change", async (e) => {
                    const f = e.target.files[0];
                    if (!f) return;
                    const data = await dataURLFromFile(f);
                    const imgs = JSON.parse(
                        localStorage.getItem(LS_IMAGES) || "{}"
                    );
                    imgs[storageKey] = data;
                    localStorage.setItem(LS_IMAGES, JSON.stringify(imgs));
                    outIds.forEach((id) => {
                        if ($(id)) {
                            $(id).src = data;
                            $(id).style.display = "block";
                        }
                    });
                    // B·ªè ch·ªçn ·∫£nh c√≥ s·∫µn khi ng∆∞·ªùi d√πng upload ·∫£nh m·ªõi
                    if (storageKey === "flowerImg") {
                        document
                            .querySelectorAll(".predefined-flower-img")
                            .forEach((img) => {
                                img.style.border = "2px solid transparent";
                            });
                    }
                });
            }
            
            
            function loadImages() {
                const imgs = JSON.parse(
                    localStorage.getItem(LS_IMAGES) || "{}"
                );
                if (!imgs) return;
                if (imgs.shopLogo && $("outLogo")) {
                    $("outLogo").src = imgs.shopLogo;
                    $("outLogo").style.display = "block";
                }
                if (imgs.flowerImg) {
                    if ($("flowerTL")) {
                        $("flowerTL").src = imgs.flowerImg;
                        $("flowerTL").style.display = "block";
                    }
                    if ($("flowerBR")) {
                        $("flowerBR").src = imgs.flowerImg;
                        $("flowerBR").style.display = "block";
                    }
                    // ƒê√°nh d·∫•u ·∫£nh c√≥ s·∫µn n·∫øu ƒë∆∞·ªùng d·∫´n kh·ªõp
                    document
                        .querySelectorAll(".predefined-flower-img")
                        .forEach((img) => {
                            if (
                                img.getAttribute("data-image") ===
                                imgs.flowerImg
                            ) {
                                img.style.border = "2px solid var(--accent)";
                            } else {
                                img.style.border = "2px solid transparent";
                            }
                        });
                }
                if (imgs.qrImg && $("outQr")) {
                    $("outQr").src = imgs.qrImg;
                    $("outQr").style.display = "block";
                }
            }

            /* ======== Theme ======== */
            function setTheme(cls) {
                document.body.classList.remove(
                    "theme-1",
                    "theme-2",
                    "theme-3",
                    "theme-4"
                );
                document.body.classList.add(cls);
                localStorage.setItem(LS_THEME, cls);
            }
            function loadTheme() {
                const t = localStorage.getItem(LS_THEME) || "theme-1";
                setTheme(t);
                document.querySelectorAll(".theme-btn").forEach((b) => {
                    if (b.dataset.theme === t) b.classList.add("selected");
                    else b.classList.remove("selected");
                });
            }

            /* ======== Debounced Update ======== */
            let updateTimeout = null;
            function debouncedUpdateInvoice() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateInvoice();
                    saveForm();
                    saveProducts();
                }, 300);
            }

            /* ======== Update preview ======== */
            function updateInvoice() {
                $("outShopName").innerText =
                    $("shopName").value.trim() || "Di·ªÖm Th√∫y Shop";
                $("outCustomerName").innerText =
                    $("customerName").value.trim() || "T√™n kh√°ch h√†ng";
                $("outCustomerPhone").innerText =
                    $("customerPhone").value.trim() || "SƒêT";
                $("outCustomerAddress").innerText =
                    $("customerAddress").value.trim() || "ƒê·ªãa ch·ªâ nh·∫≠n";
                $("outOrderDate").innerText =
                    $("orderDate").value || "__/__/____";
                $("outExpectedDate").innerText =
                    $("expectedDate").value || "__/__/____";
                $("outOrderId").innerText =
                    $("orderId").value.trim() || "M√£ ƒë∆°n";
                $("outPaymentMethod").innerText =
                    $("paymentMethod").value || "Ti·ªÅn m·∫∑t";
                $("outShortNote").innerText = $("shortNote").value.trim() || "";
                $("outThank").innerText =
                    $("thankYouText").value.trim() ||
                    "C·∫£m ∆°n anh/ch·ªã ƒë√£ tin t∆∞·ªüng Di·ªÖm Th√∫y Shop!";

                const prods = getProducts();
                const out = $("outProducts");
                out.innerHTML = "";
                let total = 0;
                if (prods.length === 0) {
                    out.innerHTML =
                        '<div style="text-align:center;color:var(--muted);padding:8px">Kh√¥ng c√≥ s·∫£n ph·∫©m</div>';
                } else {
                    const frag = document.createDocumentFragment();
                    prods.forEach((p) => {
                        const subtotal = p.qty * p.price;
                        total += subtotal;
                        const row = document.createElement("div");
                        row.className = "prod-row";
                        row.innerHTML = `<div style="flex:1">${escapeHtml(
                            p.name
                        )}</div><div style="width:36px;text-align:center">${
                            p.qty
                        }</div><div style="width:90px;text-align:right">${toCurrency(
                            p.price
                        )} ‚Ç´</div><div style="width:110px;text-align:right">${toCurrency(
                            subtotal
                        )} ‚Ç´</div>`;
                        frag.appendChild(row);
                    });
                    out.appendChild(frag);
                }
                const shipping = Number($("shippingFee").value) || 0;
                if (shipping > 0) {
                    const r = document.createElement("div");
                    r.className = "prod-row";
                    r.innerHTML = `<div style="flex:1">Ph√≠ ship</div><div style="width:36px"></div><div style="width:90px;text-align:right"></div><div style="width:110px;text-align:right">${toCurrency(
                        shipping
                    )} ‚Ç´</div>`;
                    out.appendChild(r);
                    total += shipping;
                }
                $("outTotal").innerText = toCurrency(total) + " ‚Ç´";
            }

            /* ======== Save/load products & form on start ======== */
            function loadProducts() {
                const arr = JSON.parse(
                    localStorage.getItem(LS_PRODUCTS) || "[]"
                );
                $("productList").innerHTML = "";
                if (!arr || arr.length === 0) {
                    addProduct({
                        name: "B.Begin Non-Alcohol Perfume",
                        qty: 1,
                        price: 1200000
                    });
                } else arr.forEach((p) => addProduct(p));
            }

            /* ======== Events init ======== */
            document.addEventListener("DOMContentLoaded", () => {
                // load saved
                loadForm();
                loadProducts();
                loadImages();
                loadTheme();
                updateInvoice();

                // input live update
                document
                    .querySelectorAll(
                        '#invoiceForm input:not([type="file"]), #invoiceForm textarea, #invoiceForm select'
                    )
                    .forEach((inp) =>
                        inp.addEventListener("input", debouncedUpdateInvoice)
                    );

                // file uploads (store base64)
                handleImageUpload("shopLogo", ["outLogo"], "shopLogo");
                handleImageUpload(
                    "flowerImage",
                    ["flowerTL", "flowerBR"],
                    "flowerImg"
                );
                handleImageUpload("qrImage", ["outQr"], "qrImg");

                // add/clear product
                $("addProductBtn").addEventListener("click", () => {
                    addProduct({});
                });
                $("clearProducts").addEventListener("click", () => {
                    if (confirm("X√≥a h·∫øt s·∫£n ph·∫©m?")) {
                        clearProducts();
                    }
                });

                // save/reset
                $("saveBtn").addEventListener("click", () => {
                    saveForm();
                    saveProducts();
                    alert("ƒê√£ l∆∞u v√†o tr√¨nh duy·ªát.");
                });
                $("resetBtn").addEventListener("click", () => {
                    if (confirm("Reset to√†n b·ªô d·ªØ li·ªáu?")) {
                        localStorage.clear();
                        location.reload();
                    }
                });

                // theme buttons
                document.querySelectorAll(".theme-btn").forEach((btn) =>
                    btn.addEventListener("click", () => {
                        setTheme(btn.dataset.theme);
                        btn.classList.add("selected");
                        document.querySelectorAll(".theme-btn").forEach((b) => {
                            if (b !== btn) b.classList.remove("selected");
                        });
                    })
                );

                // Predefined flower images
                document
                    .querySelectorAll(".predefined-flower-img")
                    .forEach((btn) => {
                        btn.addEventListener("click", () => {
                            const imagePath = btn.getAttribute("data-image");
                            const imgs = JSON.parse(
                                localStorage.getItem(LS_IMAGES) || "{}"
                            );
                            imgs.flowerImg = imagePath;
                            localStorage.setItem(
                                LS_IMAGES,
                                JSON.stringify(imgs)
                            );
                            $("flowerTL").src = imagePath;
                            $("flowerBR").src = imagePath;
                            $("flowerTL").style.display = "block";
                            $("flowerBR").style.display = "block";
                            // C·∫≠p nh·∫≠t tr·∫°ng th√°i "ƒë√£ ch·ªçn"
                            document
                                .querySelectorAll(".predefined-flower-img")
                                .forEach((img) => {
                                    img.style.border = "2px solid transparent";
                                });
                            btn.style.border = "2px solid var(--accent)";
                        });
                    });

                // download (safe)
                $("downloadBtn").addEventListener("click", async () => {
                    const btn = $("downloadBtn");
                    btn.disabled = true;
                    btn.textContent = "ƒêang t·∫°o ·∫£nh...";
                    try {
                        // wait images inside card to load (logo/flower/qr)
                        const imgs = Array.from(
                            document.querySelectorAll("#card img")
                        );
                        await Promise.all(
                            imgs.map(
                                (img) =>
                                    new Promise((resolve) => {
                                        if (!img.src) return resolve();
                                        if (img.complete) return resolve();
                                        img.onload = () => resolve();
                                        img.onerror = () => resolve();
                                    })
                            )
                        );

                        // compute safe scale: don't exceed 3 to avoid memory spikes
                        const card = $("card");
                        const origWidth = card.clientWidth || 360;
                        const targetWidth = 1080;
                        let scale = Math.min(
                            3,
                            Math.max(1.5, targetWidth / origWidth)
                        );
                        // render with html2canvas
                        const canvas = await html2canvas(card, {
                            useCORS: true,
                            scale: scale,
                            backgroundColor: null
                        });
                        // export via blob to avoid huge dataURL memory peak
                        canvas.toBlob(
                            (blob) => {
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement("a");
                                a.href = url;
                                a.download = `invoice_${
                                    $("orderId").value || "order"
                                }.png`;
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                setTimeout(
                                    () => URL.revokeObjectURL(url),
                                    10000
                                );
                            },
                            "image/png",
                            0.95
                        );
                    } catch (err) {
                        console.error(err);
                        alert("C√≥ l·ªói khi t·∫°o ·∫£nh. Th·ª≠ l·∫°i nh√©.");
                    } finally {
                        btn.disabled = false;
                        btn.textContent = "üì• T·∫£i h√≥a ƒë∆°n (PNG)";
                    }
                });
            }); // end DOMContentLoaded
        </script>
        <script>
    /* ======== Helpers ======== */
    const $ = (id) => document.getElementById(id);
    const LS_INVOICES = "invoice_v4_invoices";
    const LS_THEME = "invoice_v4_theme";

    function toCurrency(n) {
        return (Number(n) || 0).toLocaleString("vi-VN");
    }
    function dataURLFromFile(file) {
        return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload = (e) => res(e.target.result);
            r.onerror = rej;
            r.readAsDataURL(file);
        });
    }
    function escapeHtml(s) {
        return String(s || "").replace(
            /[&<>"']/g,
            (m) =>
                ({
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#39;"
                })[m]
        );
    }

    /* ======== Invoice Data Management ======== */
    function getInvoices() {
        try {
            return JSON.parse(localStorage.getItem(LS_INVOICES) || "[]");
        } catch (e) {
            console.error("L·ªói khi ƒë·ªçc h√≥a ƒë∆°n t·ª´ localStorage:", e);
            return [];
        }
    }

    function saveInvoices(invoices) {
        localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
        renderInvoiceHistory();
    }

    function getFormData() {
        const formFields = [
            "shopName", "customerName", "customerPhone", "customerAddress",
            "orderDate", "expectedDate", "orderId", "paymentMethod",
            "shippingFee", "shortNote", "note", "thankYouText"
        ];
        const data = {};
        formFields.forEach((id) => (data[id] = $(id).value));
        return data;
    }

    function loadFormData(data) {
        const formFields = [
            "shopName", "customerName", "customerPhone", "customerAddress",
            "orderDate", "expectedDate", "orderId", "paymentMethod",
            "shippingFee", "shortNote", "note", "thankYouText"
        ];
        formFields.forEach((id) => {
            if ($(id)) $(id).value = data[id] || "";
        });
    }

    function getProducts() {
        const nodes = document.querySelectorAll(
            "#productList .product-item"
        );
        const arr = [];
        nodes.forEach((n) => {
            const name = n.querySelector(".productName").value.trim();
            const qty = Number(n.querySelector(".productQty").value) || 0;
            const price = Number(n.querySelector(".productPrice").value) || 0;
            if (name) arr.push({ name, qty, price });
        });
        return arr;
    }

    function setProducts(products) {
        const productListEl = $("productList");
        productListEl.innerHTML = "";
        products.forEach(p => addProduct(p));
    }

    async function saveCurrentInvoice() {
        const name = prompt("Nh·∫≠p t√™n cho h√≥a ƒë∆°n:");
        if (!name) return;

        const invoices = getInvoices();
        const newInvoice = {
            id: Date.now(),
            name: name,
            formData: getFormData(),
            products: getProducts(),
            images: JSON.parse(localStorage.getItem("invoice_v4_images") || "{}"),
            theme: localStorage.getItem(LS_THEME) || "theme-1",
            dateSaved: new Date().toISOString()
        };
        invoices.unshift(newInvoice);
        saveInvoices(invoices);
    }

    function loadInvoice(invoiceId) {
        const invoices = getInvoices();
        const invoice = invoices.find(inv => inv.id === invoiceId);
        if (!invoice) return alert("Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n!");

        loadFormData(invoice.formData);
        setProducts(invoice.products);
        localStorage.setItem("invoice_v4_images", JSON.stringify(invoice.images));
        loadImages();
        setTheme(invoice.theme);

        debouncedUpdateInvoice();
        alert(`ƒê√£ t·∫£i h√≥a ƒë∆°n "${invoice.name}".`);
    }

    function deleteInvoice(invoiceId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y?")) return;
        const invoices = getInvoices().filter(inv => inv.id !== invoiceId);
        saveInvoices(invoices);
        alert("ƒê√£ x√≥a h√≥a ƒë∆°n.");
    }

    function clearAllHistory() {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ h√≥a ƒë∆°n ƒë√£ l∆∞u?")) return;
        saveInvoices([]);
        alert("ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠ h√≥a ƒë∆°n.");
    }
    
    function renderInvoiceHistory() {
        const listEl = $("invoiceHistoryList");
        const invoices = getInvoices();
        listEl.innerHTML = "";
        if (invoices.length === 0) {
            listEl.innerHTML = '<div style="text-align: center; color: var(--muted)">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o ƒë∆∞·ª£c l∆∞u.</div>';
            return;
        }

        invoices.forEach(inv => {
            const item = document.createElement("div");
            item.className = "history-list-item";
            item.innerHTML = `
                <div style="flex:1;">
                    <strong style="display:block">${escapeHtml(inv.name)}</strong>
                    <span class="small">${new Date(inv.dateSaved).toLocaleDateString()} - ${escapeHtml(inv.formData.customerName || "Kh√°ch h√†ng")}</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn ghost" onclick="loadInvoice(${inv.id})">S·ª≠a</button>
                    <button class="btn warn" onclick="deleteInvoice(${inv.id})">X√≥a</button>
                </div>
            `;
            listEl.appendChild(item);
        });
    }


    /* ======== Products (re-used) ======== */
    function createProductElement(p = {}) {
        const el = document.createElement("div");
        el.className = "product-item";
        el.innerHTML = `
            <input class="productName" placeholder="T√™n s·∫£n ph·∫©m" value="${escapeHtml(
                p.name || ""
            )}">
            <input class="productQty" placeholder="SL" type="number" min="0" value="${
                p.qty || ""
            }">
            <input class="productPrice" placeholder="Gi√° (VNƒê)" type="number" min="0" value="${
                p.price || ""
            }">
            <button class="remove-btn" title="X√≥a">‚úï</button>
        `;
        el.querySelector(".remove-btn").addEventListener(
            "click",
            () => {
                el.remove();
                debouncedUpdateInvoice();
            }
        );
        el.querySelectorAll("input").forEach((i) =>
            i.addEventListener("input", debouncedUpdateInvoice)
        );
        return el;
    }

    function addProduct(p) {
        $("productList").appendChild(createProductElement(p || {}));
    }
    
    function clearProducts() {
        $("productList").innerHTML = "";
        debouncedUpdateInvoice();
    }

    /* ======== Images (re-used) ======== */
    async function handleImageUpload(inputId, outIds, storageKey) {
        const input = $(inputId);
        if (!input) return;
        input.addEventListener("change", async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const imgs = JSON.parse(
                localStorage.getItem("invoice_v4_images") || "{}"
            );
            imgs[storageKey] = await dataURLFromFile(f);
            localStorage.setItem("invoice_v4_images", JSON.stringify(imgs));
            loadImages();
        });
    }
    
    function loadImages() {
        const imgs = JSON.parse(
            localStorage.getItem("invoice_v4_images") || "{}"
        );
        if (!imgs) return;
        const images = {
            shopLogo: "outLogo",
            flowerImg: ["flowerTL", "flowerBR"],
            qrImg: "outQr",
        };
        for (const key in images) {
            const imgEl = $(images[key]);
            if (imgEl) {
                imgEl.src = imgs[key] || "";
                imgEl.style.display = imgs[key] ? "block" : "none";
            } else if (Array.isArray(images[key])) {
                images[key].forEach(id => {
                    const el = $(id);
                    if (el) {
                        el.src = imgs[key] || "";
                        el.style.display = imgs[key] ? "block" : "none";
                    }
                })
            }
        }
    }


    /* ======== Theme (re-used) ======== */
    function setTheme(cls) {
        document.body.classList.remove(
            "theme-1",
            "theme-2",
            "theme-3",
            "theme-4"
        );
        document.body.classList.add(cls);
        localStorage.setItem(LS_THEME, cls);
    }
    function loadTheme() {
        const t = localStorage.getItem(LS_THEME) || "theme-1";
        setTheme(t);
        document.querySelectorAll(".theme-btn").forEach((b) => {
            if (b.dataset.theme === t) b.classList.add("selected");
            else b.classList.remove("selected");
        });
    }

    /* ======== Debounced Update (re-used) ======== */
    let updateTimeout = null;
    function debouncedUpdateInvoice() {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            updateInvoice();
        }, 300);
    }

    /* ======== Update preview (re-used) ======== */
    function updateInvoice() {
        $("outShopName").innerText = $("shopName").value.trim() || "Di·ªÖm Th√∫y Shop";
        $("outCustomerName").innerText = $("customerName").value.trim() || "T√™n kh√°ch h√†ng";
        $("outCustomerPhone").innerText = $("customerPhone").value.trim() || "SƒêT";
        $("outCustomerAddress").innerText = $("customerAddress").value.trim() || "ƒê·ªãa ch·ªâ nh·∫≠n";
        $("outOrderDate").innerText = $("orderDate").value || "__/__/____";
        $("outExpectedDate").innerText = $("expectedDate").value || "__/__/____";
        $("outOrderId").innerText = $("orderId").value.trim() || "M√£ ƒë∆°n";
        $("outPaymentMethod").innerText = $("paymentMethod").value || "Ti·ªÅn m·∫∑t";
        $("outShortNote").innerText = $("shortNote").value.trim() || "";
        $("outThank").innerText = $("thankYouText").value.trim() || "C·∫£m ∆°n anh/ch·ªã ƒë√£ tin t∆∞·ªüng Di·ªÖm Th√∫y Shop!";

        const prods = getProducts();
        const out = $("outProducts");
        out.innerHTML = "";
        let total = 0;
        if (prods.length === 0) {
            out.innerHTML = '<div style="text-align:center;color:var(--muted);padding:8px">Kh√¥ng c√≥ s·∫£n ph·∫©m</div>';
        } else {
            const frag = document.createDocumentFragment();
            prods.forEach((p) => {
                const subtotal = p.qty * p.price;
                total += subtotal;
                const row = document.createElement("div");
                row.className = "prod-row";
                row.innerHTML = `<div style="flex:1">${escapeHtml(p.name)}</div><div style="width:36px;text-align:center">${p.qty}</div><div style="width:90px;text-align:right">${toCurrency(p.price)} ‚Ç´</div><div style="width:110px;text-align:right">${toCurrency(subtotal)} ‚Ç´</div>`;
                frag.appendChild(row);
            });
            out.appendChild(frag);
        }
        const shipping = Number($("shippingFee").value) || 0;
        if (shipping > 0) {
            const r = document.createElement("div");
            r.className = "prod-row";
            r.innerHTML = `<div style="flex:1">Ph√≠ ship</div><div style="width:36px"></div><div style="width:90px;text-align:right"></div><div style="width:110px;text-align:right">${toCurrency(shipping)} ‚Ç´</div>`;
            out.appendChild(r);
            total += shipping;
        }
        $("outTotal").innerText = toCurrency(total) + " ‚Ç´";
    }

    /* ======== Initial load ======== */
    function loadLastSavedInvoiceOrDefaults() {
        const invoices = getInvoices();
        if (invoices.length > 0) {
            const latest = invoices[0];
            loadFormData(latest.formData);
            setProducts(latest.products);
            localStorage.setItem("invoice_v4_images", JSON.stringify(latest.images));
            loadImages();
            setTheme(latest.theme);
        } else {
            setProducts([{ name: "B.Begin Non-Alcohol Perfume", qty: 1, price: 1200000 }]);
            loadTheme();
            loadImages();
        }
        debouncedUpdateInvoice();
    }

    function resetFormToDefaults() {
        const inputs = document.querySelectorAll(
            '#invoiceForm input:not([type="file"]), #invoiceForm textarea, #invoiceForm select'
        );
        inputs.forEach(inp => {
            inp.value = "";
        });
        const initialProducts = [{ name: "B.Begin Non-Alcohol Perfume", qty: 1, price: 1200000 }];
        setProducts(initialProducts);
        localStorage.removeItem("invoice_v4_images");
        loadImages();
        loadTheme();
        debouncedUpdateInvoice();
    }


    /* ======== Events init ======== */
    document.addEventListener("DOMContentLoaded", () => {
        // load saved
        loadLastSavedInvoiceOrDefaults();
        renderInvoiceHistory();

        // input live update
        document
            .querySelectorAll(
                '#invoiceForm input:not([type="file"]), #invoiceForm textarea, #invoiceForm select'
            )
            .forEach((inp) =>
                inp.addEventListener("input", debouncedUpdateInvoice)
            );

        // file uploads (store base64)
        handleImageUpload("shopLogo", ["outLogo"], "shopLogo");
        handleImageUpload("flowerImage", ["flowerTL", "flowerBR"], "flowerImg");
        handleImageUpload("qrImage", ["outQr"], "qrImg");

        // add/clear product
        $("addProductBtn").addEventListener("click", () => {
            addProduct({});
            debouncedUpdateInvoice();
        });
        $("clearProducts").addEventListener("click", () => {
            if (confirm("X√≥a h·∫øt s·∫£n ph·∫©m?")) {
                clearProducts();
            }
        });

        // save/reset
        $("saveBtn").addEventListener("click", saveCurrentInvoice);
        $("resetBtn").addEventListener("click", () => {
            if (confirm("Reset form v·ªÅ m·∫∑c ƒë·ªãnh?")) {
                resetFormToDefaults();
            }
        });
        $("clearAllHistoryBtn").addEventListener("click", clearAllHistory);


        // theme buttons
        document.querySelectorAll(".theme-btn").forEach((btn) =>
            btn.addEventListener("click", () => {
                setTheme(btn.dataset.theme);
                btn.classList.add("selected");
                document.querySelectorAll(".theme-btn").forEach((b) => {
                    if (b !== btn) b.classList.remove("selected");
                });
            })
        );

        // download (safe)
        $("downloadBtn").addEventListener("click", async () => {
            const btn = $("downloadBtn");
            btn.disabled = true;
            btn.textContent = "ƒêang t·∫°o ·∫£nh...";
            try {
                const imgs = Array.from(document.querySelectorAll("#card img"));
                await Promise.all(
                    imgs.map(
                        (img) =>
                            new Promise((resolve) => {
                                if (!img.src) return resolve();
                                if (img.complete) return resolve();
                                img.onload = () => resolve();
                                img.onerror = () => resolve();
                            })
                    )
                );
                const card = $("card");
                const origWidth = card.clientWidth || 360;
                const targetWidth = 1080;
                let scale = Math.min(3, Math.max(1.5, targetWidth / origWidth));
                const canvas = await html2canvas(card, {
                    useCORS: true,
                    scale: scale,
                    backgroundColor: null
                });
                canvas.toBlob(
                    (blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `invoice_${$("orderId").value || "order"}.png`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        setTimeout(() => URL.revokeObjectURL(url), 10000);
                    },
                    "image/png",
                    0.95
                );
            } catch (err) {
                console.error(err);
                alert("C√≥ l·ªói khi t·∫°o ·∫£nh. Th·ª≠ l·∫°i nh√©.");
            } finally {
                btn.disabled = false;
                btn.textContent = "üì• T·∫£i h√≥a ƒë∆°n (PNG)";
            }
        });
    }); // end DOMContentLoaded
</

    </body>
</html>
