<!doctype html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Invoice Generator — Mobile First (Safe Export)</title>

        <link
            href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap"
            rel="stylesheet" />
        <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap"
            rel="stylesheet" />
        <link
            href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
            rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        <style>
            :root {
                --page-bg: #f8f1e7;
                --card-bg: #fff;
                --text: #40342e;
                --muted: #7a6f68;
                --accent: #d4b483;
                --max-width: 980px;
            }
            /* themes */
            .theme-1 {
                --card-bg: #fff;
                --page-bg: #f8f1e7;
                --text: #40342e;
                --accent: #d4b483;
            }
            .theme-2 {
                --card-bg: #fffaf7;
                --page-bg: #f0f7f6;
                --text: #2c3e3a;
                --accent: #7cc6b6;
            }
            .theme-3 {
                --card-bg: #fff;
                --page-bg: #f4f7ff;
                --text: #2e3658;
                --accent: #9aa8ff;
            }
            .theme-4 {
                --card-bg: #fff;
                --page-bg: #fff7f9;
                --text: #3d2b2b;
                --accent: #ffb3c6;
            }

            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
                margin: 0;
                font-family: "Poppins", sans-serif;
                background: var(--page-bg);
                color: var(--text);
            }
            .wrap {
                max-width: var(--max-width);
                margin: 12px auto;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            header {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }
            header h1 {
                font-family: "Playfair Display", serif;
                margin: 0;
                font-size: 24px;
                text-align: center;
                margin-top: 16px;
            }
            header p {
                margin: 0;

                font-size: 13px;
            }

            /* MOBILE-FIRST layout */
            .main {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .panel {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 12px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            }
            label {
                display: block;
                font-size: 13px;
                color: var(--muted);
                margin-bottom: 6px;
            }
            input[type="text"],
            input[type="number"],
            input[type="date"],
            select,
            input,
            textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #e6e0d8;
                background: transparent;
                font-size: 14px;
                color: var(--text);
                min-width: 0;
            }
            textarea {
                min-height: 70px;
                resize: vertical;
            }
            .row {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .col {
                flex: 1;
                min-width: 120px;
            }
            .swatch.selected {
                border: 2px solid var(--accent);
                box-shadow: 0 0 0 1px #fff;
            }

            .small {
                font-size: 12px;
                color: var(--muted);
            }
            .callout {
                font-weight: 700;
                margin: 8px 0;
            }

            .btn {
                display: inline-block;
                padding: 10px 12px;
                border-radius: 8px;
                border: 0;
                cursor: pointer;
                background: var(--accent);
                color: #fff;
                font-weight: 600;
            }
            .btn.ghost {
                background: transparent;
                border: 1px solid rgba(0, 0, 0, 0.06);
                color: var(--text);
            }
            .btn.warn {
                background: #e86f6f;
            }
            .actions {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-top: 8px;
            }

            /* product list */
            .product-item {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-bottom: 8px;
                flex-wrap: wrap;
            }
            .product-item input {
                flex: 1;
                min-width: 90px;
            }
            .remove-btn {
                background: #e86f6f;
                border: none;
                color: #fff;
                padding: 4px 6px;
                border-radius: 6px;
                cursor: pointer;
            }

            .feature-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                margin: 12px 0px;
            }
            .feature-item {
                background: var(--card-bg);
                padding: 6px 9px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                flex: 1;
                min-width: 200px;
                background: var(--accent);
                font-size: 12px;
                font-weight: 700;
            }
            .feature-item .icon {
                font-size: 14px;
            }

            /* Điều chỉnh lại cho màn hình nhỏ hơn */
            @media (max-width: 600px) {
                .feature-item {
                    min-width: 80%;
                    justify-content: center;
                }
            }

            /* preview */
            .preview-wrap {
                display: flex;
                justify-content: center;
            }
            .history-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.history-list-item:last-child {
    border-bottom: none;
}
.history-list-item button {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 6px;
}

            .card {
                width: 360px;
                background: var(--card-bg);
                border-radius: 14px;
                padding: 16px;
                position: relative;
                box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08);
                overflow: hidden;
            }
            .corner {
                position: absolute;
                opacity: 0.22;
                z-index: 0;
                width: 150px;
            }
            .corner.tl {
                top: -6px;
                left: -6px;
            }
            .corner.br {
                bottom: -6px;
                right: -6px;

                transform: rotate(180deg);
            }
            .logo {
                max-height: 50px;
                display: block;
                margin: 0 auto 6px;
                z-index: 1;
            }
            .shop-name {
                text-align: center;
                font-family: "Playfair Display", serif;
                font-size: 18px;
                margin-bottom: 6px;
                color: var(--text);
            }
            .title {
                text-align: center;
                font-weight: 700;
                color: var(--accent);
                font-size: 12px;
                margin-bottom: 8px;
            }
            .meta {
                font-size: 13px;
                color: var(--text);
                z-index: 1;
                margin-bottom: 8px;
            }
            .meta .row {
                display: flex;
                justify-content: space-between;
                gap: 8px;
            }
            .products {
                background: rgba(255, 255, 255, 0.6);
                padding: 8px;
                border-radius: 8px;
                z-index: 1;
                margin-bottom: 8px;
                min-height: 40px;
            }
            .prod-row {
                display: flex;
                justify-content: space-between;
                font-size: 12px;
                padding: 6px 0;
                border-bottom: 1px dashed rgba(0, 0, 0, 0.04);
            }
            .prod-row:last-child {
                border-bottom: none;
            }
            .total {
                display: flex;
                justify-content: space-between;
                font-weight: 700;
                padding-top: 8px;
                border-top: 1px solid rgba(0, 0, 0, 0.04);
                margin-top: 8px;
            }
            .note {
                text-align: center;
                font-style: italic;
                color: var(--muted);
                font-size: 13px;
                margin-top: 8px;
            }
            .qr {
                display: block;
                margin: 8px auto 0;
                max-width: 140px;
            }
            .footer {
                text-align: center;
                font-size: 16px;
                color: var(--muted);
                margin-top: 8px;
                font-family: "Dancing Script", cursive;
            }

            /* Desktop */
            @media (min-width: 900px) {
                .main {
                    flex-direction: row;
                    gap: 16px;
                }
                .left {
                    flex: 0 0 420px;
                }
                .right {
                    flex: 1;
                    display: flex;
                    align-items: flex-start;
                    justify-content: center;
                }
                .card {
                    width: 420px;
                }
            }
        </style>
    </head>
    <body class="theme-1">
        <div class="wrap">
            <header>
                <h1>Tạo Hóa Đơn Đẹp & Chuyên Nghiệp chỉ trong 30 giây</h1>
                <p class="small" style="text-align: center">
                    Tùy chỉnh, xem trước trực tiếp, lưu lại và xuất ảnh PNG an
                    toàn ngay trên điện thoại
                </p>
                <p class="callout">
                    "Công cụ tạo hóa đơn hoàn miễn phí, không cần đăng nhập. Bạn
                    có thể dễ dàng tạo, tùy chỉnh và lưu lại mẫu hóa đơn yêu
                    thích ngay trong trình duyệt. Phù hợp cho các shop online,
                    freelancer hay doanh nghiệp nhỏ"
                </p>
                <div class="feature-list">
                    <div class="feature-item">
                        <span class="icon">✨</span>
                        <span>Hoàn toàn miễn phí</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">🔒</span>
                        <span>An toàn & Riêng tư</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">🖌️</span>
                        <span>Tùy chỉnh linh hoạt</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">⚡</span>
                        <span>Xem trước trực tiếp</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">📥</span>
                        <span>Xuất file chất lượng cao</span>
                    </div>
                </div>
            </header>

            <div class="main">
    <div class="left panel">
        <div id="invoiceForm" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="text-align: center">
                <strong class="small">Tạo hóa đơn mới</strong>
                <p class="small">
                    Điền thông tin vào form bên dưới để tạo hóa đơn của bạn.
                </p>
            </div>
            <div>
                <label class="small">Tên shop</label>
                <input id="shopName" placeholder="Diễm Thúy Shop" />
                <label class="small">Logo (upload)</label>
                <input id="shopLogo" type="file" accept="image/*" />
            </div>
            <div>
                <label class="small">Tên khách</label>
                <input id="customerName" placeholder="Nguyễn Văn A" />
                <div class="row" style="margin-top: 6px">
                    <div class="col">
                        <label class="small">SĐT</label>
                        <input id="customerPhone" placeholder="0909xxxxxx" />
                    </div>
                    <div class="col">
                        <label class="small">Ngày đặt</label>
                        <input id="orderDate" type="date" />
                    </div>
                </div>
                <label class="small" style="margin-top: 6px">Địa chỉ nhận</label>
                <textarea id="customerAddress" placeholder="123 Lê Lợi, Quận 1, TP.HCM"></textarea>
            </div>
            <div>
                <div class="row">
                    <div class="col">
                        <label class="small">Mã đơn</label>
                        <input id="orderId" placeholder="DH001" />
                    </div>
                    <div class="col">
                        <label class="small">Ngày nhận dự kiến</label>
                        <input id="expectedDate" type="date" />
                    </div>
                </div>
                <div class="row" style="margin-top: 6px">
                    <div class="col">
                        <label class="small">Phương thức</label>
                        <select id="paymentMethod">
                            <option>Tiền mặt</option>
                            <option>Chuyển khoản</option>
                            <option>COD</option>
                        </select>
                    </div>
                    <div class="col">
                        <label class="small">Phí ship (VNĐ)</label>
                        <input id="shippingFee" type="number" placeholder="0" />
                    </div>
                </div>
                <label class="small" style="margin-top: 6px">Mã giảm / note ngắn</label>
                <input id="shortNote" placeholder="Voucher / ghi chú ngắn" />
            </div>
            <div>
                <label class="small">Sản phẩm</label>
                <div id="productList"></div>
                <div class="actions">
                    <button id="addProductBtn" class="btn" type="button">
                        + Thêm sản phẩm
                    </button>
                    <button id="clearProducts" class="btn ghost" type="button">
                        Xóa hết
                    </button>
                </div>
                <div class="small" style="margin-top: 8px"></div>
            </div>
            <div style="margin-top: 8px">
                <label class="small">Ghi chú dài (nếu cần)</label>
                <textarea id="note" placeholder="Ghi chú cho đơn"></textarea>
            </div>
            <div style="margin-top: 8px">
                <label class="small">Ảnh hoa góc (PNG)</label>
                <input id="flowerImage" type="file" accept="image/*" />
                <label class="small" style="margin-top: 6px">QR chuyển khoản (upload)</label>
                <input id="qrImage" type="file" accept="image/*" />
                <label class="small" style="margin-top: 6px">Lời cảm ơn (footer)</label>
                <input id="thankYouText" placeholder="Cảm ơn anh/chị đã tin tưởng Diễm Thúy Shop 🌿" />
                <div style="margin-top: 8px">
                    <div class="small">Chọn bộ màu</div>
                    <div style="display: flex; gap: 8px; margin-top: 6px;">
                        <div class="swatch theme-btn" data-theme="theme-1" style="width: 34px; height: 24px; background: linear-gradient(#fff, #f6efe6); border-radius: 6px;"></div>
                        <div class="swatch theme-btn" data-theme="theme-2" style="width: 34px; height: 24px; background: linear-gradient(#fffaf7, #e7f6f3); border-radius: 6px;"></div>
                        <div class="swatch theme-btn" data-theme="theme-3" style="width: 34px; height: 24px; background: linear-gradient(#fff, #eef5ff); border-radius: 6px;"></div>
                        <div class="swatch theme-btn" data-theme="theme-4" style="width: 34px; height: 24px; background: linear-gradient(#fff, #fff1f4); border-radius: 6px;"></div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button id="saveBtn" class="btn" type="button">
                    Lưu hóa đơn
                </button>
                <button id="resetBtn" class="btn ghost" type="button">
                    Reset
                </button>
            </div>
        </div>
    </div>
    <div class="right panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div>
                <strong class="small">Preview</strong>
            </div>
        </div>
        <div class="preview-wrap">
            <div id="card" class="card" role="img" aria-label="Invoice preview">
                <img id="flowerTL" class="corner tl" src="" alt="" style="display: none" />
                <img id="flowerBR" class="corner br" src="" alt="" style="display: none" />
                <img id="outLogo" class="logo" src="" alt="" style="display: none" />
                <div class="shop-name" id="outShopName">
                    Diễm Thúy Shop
                </div>
                <div class="title">XÁC NHẬN ĐƠN HÀNG</div>
                <div class="meta">
                    <div class="row">
                        <div>
                            <strong>Khách:</strong>
                            <span id="outCustomerName">Nguyễn Văn A</span>
                        </div>
                        <div>
                            <strong>SĐT:</strong>
                            <span id="outCustomerPhone">0909xxxxxx</span>
                        </div>
                    </div>
                    <div style="margin-top: 6px">
                        <strong>Địa chỉ:</strong>
                        <span id="outCustomerAddress">123 Lê Lợi, Q1</span>
                    </div>
                    <div style="margin-top: 6px" class="row">
                        <div>
                            <strong>Ngày đặt:</strong>
                            <span id="outOrderDate">__/__/____</span>
                        </div>
                        <div>
                            <strong>Nhận dự kiến:</strong>
                            <span id="outExpectedDate">__/__/____</span>
                        </div>
                    </div>
                    <div style="margin-top: 6px" class="row">
                        <div>
                            <strong>Mã:</strong>
                            <span id="outOrderId">DH001</span>
                        </div>
                        <div>
                            <strong>Thanh toán:</strong>
                            <span id="outPaymentMethod">Tiền mặt</span>
                        </div>
                    </div>
                </div>
                <div class="products" id="outProducts"></div>
                <div class="total">
                    <div>Tổng</div>
                    <div id="outTotal">0 ₫</div>
                </div>
                <div class="note" id="outShortNote"></div>
                <img id="outQr" class="qr" src="" alt="" style="display: none" />
                <div class="footer" id="outThank">
                    Cảm ơn anh/chị đã tin tưởng Diễm Thúy Shop!
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px; justify-content: center;">
            <button id="downloadBtn" class="btn">
                📥 Tải hóa đơn (PNG)
            </button>
        </div>
    </div>
</div>

<div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong class="small">Hóa đơn đã lưu</strong>
        <button id="clearAllHistoryBtn" class="btn warn" type="button">Xóa tất cả</button>
    </div>
    <div id="invoiceHistoryList" style="margin-top: 12px">
        <div style="text-align: center; color: var(--muted)">Chưa có hóa đơn nào được lưu.</div>
    </div>
</div>


            <footer
                style="
                    text-align: center;
                    font-size: 12px;
                    color: var(--muted);
                    margin-top: 6px;
                ">
                Lưu cục bộ trên trình duyệt — Không upload server - Không lo bị
                lộ thông tin
            </footer>
        </div>

        <script>
            /* ======== Helpers ======== */
            const $ = (id) => document.getElementById(id);
            const LS_FORM = "invoice_v3_form";
            const LS_PRODUCTS = "invoice_v3_products";
            const LS_IMAGES = "invoice_v3_images";
            const LS_THEME = "invoice_v3_theme";

            function toCurrency(n) {
                return (Number(n) || 0).toLocaleString("vi-VN");
            }
            function dataURLFromFile(file) {
                return new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = (e) => res(e.target.result);
                    r.onerror = rej;
                    r.readAsDataURL(file);
                });
            }
            function escapeHtml(s) {
                return String(s || "").replace(
                    /[&<>"']/g,
                    (m) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;"
                        })[m]
                );
            }

            /* ======== Products ======== */
            function createProductElement(p = {}) {
                const el = document.createElement("div");
                el.className = "product-item";
                el.innerHTML = `
                    <input class="productName" placeholder="Tên sản phẩm" value="${escapeHtml(
                        p.name || ""
                    )}">
                    <input class="productQty" placeholder="SL" type="number" min="0" value="${
                        p.qty || ""
                    }">
                    <input class="productPrice" placeholder="Giá (VNĐ)" type="number" min="0" value="${
                        p.price || ""
                    }">
                    <button class="remove-btn" title="Xóa">×</button>
                `;
                el.querySelector(".remove-btn").addEventListener(
                    "click",
                    () => {
                        el.remove();
                        debouncedUpdateInvoice();
                    }
                );
                el.querySelectorAll("input").forEach((i) =>
                    i.addEventListener("input", debouncedUpdateInvoice)
                );
                return el;
            }
            function addProduct(p) {
                $("productList").appendChild(createProductElement(p || {}));
                debouncedUpdateInvoice();
            }
            function clearProducts() {
                $("productList").innerHTML = "";
                debouncedUpdateInvoice();
            }
            function getProducts() {
                const nodes = document.querySelectorAll(
                    "#productList .product-item"
                );
                const arr = [];
                nodes.forEach((n) => {
                    const name = n.querySelector(".productName").value.trim();
                    const qty =
                        Number(n.querySelector(".productQty").value) || 0;
                    const price =
                        Number(n.querySelector(".productPrice").value) || 0;
                    if (name) arr.push({ name, qty, price });
                });
                return arr;
            }
            function saveProducts() {
                localStorage.setItem(
                    LS_PRODUCTS,
                    JSON.stringify(getProducts())
                );
            }

            /* ======== Form save/load ======== */
            function saveForm() {
                const ids = [
                    "shopName",
                    "customerName",
                    "customerPhone",
                    "customerAddress",
                    "orderDate",
                    "expectedDate",
                    "orderId",
                    "paymentMethod",
                    "shippingFee",
                    "shortNote",
                    "note",
                    "thankYouText"
                ];
                const data = {};
                ids.forEach((id) => {
                    const el = $(id);
                    if (el) data[id] = el.value;
                });
                localStorage.setItem(LS_FORM, JSON.stringify(data));
            }
            function loadForm() {
                const data = JSON.parse(localStorage.getItem(LS_FORM) || "{}");
                if (!data) return;
                Object.keys(data).forEach((k) => {
                    if ($(k)) $(k).value = data[k];
                });
            }

            /* ======== Images save/load (base64) ======== */
            async function handleImageUpload(inputId, outIds, storageKey) {
                const input = $(inputId);
                if (!input) return;
                input.addEventListener("change", async (e) => {
                    const f = e.target.files[0];
                    if (!f) return;
                    const data = await dataURLFromFile(f);
                    const imgs = JSON.parse(
                        localStorage.getItem(LS_IMAGES) || "{}"
                    );
                    imgs[storageKey] = data;
                    localStorage.setItem(LS_IMAGES, JSON.stringify(imgs));
                    outIds.forEach((id) => {
                        if ($(id)) {
                            $(id).src = data;
                            $(id).style.display = "block";
                        }
                    });
                    // Bỏ chọn ảnh có sẵn khi người dùng upload ảnh mới
                    if (storageKey === "flowerImg") {
                        document
                            .querySelectorAll(".predefined-flower-img")
                            .forEach((img) => {
                                img.style.border = "2px solid transparent";
                            });
                    }
                });
            }
            
            
            function loadImages() {
                const imgs = JSON.parse(
                    localStorage.getItem(LS_IMAGES) || "{}"
                );
                if (!imgs) return;
                if (imgs.shopLogo && $("outLogo")) {
                    $("outLogo").src = imgs.shopLogo;
                    $("outLogo").style.display = "block";
                }
                if (imgs.flowerImg) {
                    if ($("flowerTL")) {
                        $("flowerTL").src = imgs.flowerImg;
                        $("flowerTL").style.display = "block";
                    }
                    if ($("flowerBR")) {
                        $("flowerBR").src = imgs.flowerImg;
                        $("flowerBR").style.display = "block";
                    }
                    // Đánh dấu ảnh có sẵn nếu đường dẫn khớp
                    document
                        .querySelectorAll(".predefined-flower-img")
                        .forEach((img) => {
                            if (
                                img.getAttribute("data-image") ===
                                imgs.flowerImg
                            ) {
                                img.style.border = "2px solid var(--accent)";
                            } else {
                                img.style.border = "2px solid transparent";
                            }
                        });
                }
                if (imgs.qrImg && $("outQr")) {
                    $("outQr").src = imgs.qrImg;
                    $("outQr").style.display = "block";
                }
            }

            /* ======== Theme ======== */
            function setTheme(cls) {
                document.body.classList.remove(
                    "theme-1",
                    "theme-2",
                    "theme-3",
                    "theme-4"
                );
                document.body.classList.add(cls);
                localStorage.setItem(LS_THEME, cls);
            }
            function loadTheme() {
                const t = localStorage.getItem(LS_THEME) || "theme-1";
                setTheme(t);
                document.querySelectorAll(".theme-btn").forEach((b) => {
                    if (b.dataset.theme === t) b.classList.add("selected");
                    else b.classList.remove("selected");
                });
            }

            /* ======== Debounced Update ======== */
            let updateTimeout = null;
            function debouncedUpdateInvoice() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateInvoice();
                    saveForm();
                    saveProducts();
                }, 300);
            }

            /* ======== Update preview ======== */
            function updateInvoice() {
                $("outShopName").innerText =
                    $("shopName").value.trim() || "Diễm Thúy Shop";
                $("outCustomerName").innerText =
                    $("customerName").value.trim() || "Tên khách hàng";
                $("outCustomerPhone").innerText =
                    $("customerPhone").value.trim() || "SĐT";
                $("outCustomerAddress").innerText =
                    $("customerAddress").value.trim() || "Địa chỉ nhận";
                $("outOrderDate").innerText =
                    $("orderDate").value || "__/__/____";
                $("outExpectedDate").innerText =
                    $("expectedDate").value || "__/__/____";
                $("outOrderId").innerText =
                    $("orderId").value.trim() || "Mã đơn";
                $("outPaymentMethod").innerText =
                    $("paymentMethod").value || "Tiền mặt";
                $("outShortNote").innerText = $("shortNote").value.trim() || "";
                $("outThank").innerText =
                    $("thankYouText").value.trim() ||
                    "Cảm ơn anh/chị đã tin tưởng Diễm Thúy Shop!";

                const prods = getProducts();
                const out = $("outProducts");
                out.innerHTML = "";
                let total = 0;
                if (prods.length === 0) {
                    out.innerHTML =
                        '<div style="text-align:center;color:var(--muted);padding:8px">Không có sản phẩm</div>';
                } else {
                    const frag = document.createDocumentFragment();
                    prods.forEach((p) => {
                        const subtotal = p.qty * p.price;
                        total += subtotal;
                        const row = document.createElement("div");
                        row.className = "prod-row";
                        row.innerHTML = `<div style="flex:1">${escapeHtml(
                            p.name
                        )}</div><div style="width:36px;text-align:center">${
                            p.qty
                        }</div><div style="width:90px;text-align:right">${toCurrency(
                            p.price
                        )} ₫</div><div style="width:110px;text-align:right">${toCurrency(
                            subtotal
                        )} ₫</div>`;
                        frag.appendChild(row);
                    });
                    out.appendChild(frag);
                }
                const shipping = Number($("shippingFee").value) || 0;
                if (shipping > 0) {
                    const r = document.createElement("div");
                    r.className = "prod-row";
                    r.innerHTML = `<div style="flex:1">Phí ship</div><div style="width:36px"></div><div style="width:90px;text-align:right"></div><div style="width:110px;text-align:right">${toCurrency(
                        shipping
                    )} ₫</div>`;
                    out.appendChild(r);
                    total += shipping;
                }
                $("outTotal").innerText = toCurrency(total) + " ₫";
            }

            /* ======== Save/load products & form on start ======== */
            function loadProducts() {
                const arr = JSON.parse(
                    localStorage.getItem(LS_PRODUCTS) || "[]"
                );
                $("productList").innerHTML = "";
                if (!arr || arr.length === 0) {
                    addProduct({
                        name: "B.Begin Non-Alcohol Perfume",
                        qty: 1,
                        price: 1200000
                    });
                } else arr.forEach((p) => addProduct(p));
            }

            /* ======== Events init ======== */
            document.addEventListener("DOMContentLoaded", () => {
                // load saved
                loadForm();
                loadProducts();
                loadImages();
                loadTheme();
                updateInvoice();

                // input live update
                document
                    .querySelectorAll(
                        '#invoiceForm input:not([type="file"]), #invoiceForm textarea, #invoiceForm select'
                    )
                    .forEach((inp) =>
                        inp.addEventListener("input", debouncedUpdateInvoice)
                    );

                // file uploads (store base64)
                handleImageUpload("shopLogo", ["outLogo"], "shopLogo");
                handleImageUpload(
                    "flowerImage",
                    ["flowerTL", "flowerBR"],
                    "flowerImg"
                );
                handleImageUpload("qrImage", ["outQr"], "qrImg");

                // add/clear product
                $("addProductBtn").addEventListener("click", () => {
                    addProduct({});
                });
                $("clearProducts").addEventListener("click", () => {
                    if (confirm("Xóa hết sản phẩm?")) {
                        clearProducts();
                    }
                });

                // save/reset
                $("saveBtn").addEventListener("click", () => {
                    saveForm();
                    saveProducts();
                    alert("Đã lưu vào trình duyệt.");
                });
                $("resetBtn").addEventListener("click", () => {
                    if (confirm("Reset toàn bộ dữ liệu?")) {
                        localStorage.clear();
                        location.reload();
                    }
                });

                // theme buttons
                document.querySelectorAll(".theme-btn").forEach((btn) =>
                    btn.addEventListener("click", () => {
                        setTheme(btn.dataset.theme);
                        btn.classList.add("selected");
                        document.querySelectorAll(".theme-btn").forEach((b) => {
                            if (b !== btn) b.classList.remove("selected");
                        });
                    })
                );

                // Predefined flower images
                document
                    .querySelectorAll(".predefined-flower-img")
                    .forEach((btn) => {
                        btn.addEventListener("click", () => {
                            const imagePath = btn.getAttribute("data-image");
                            const imgs = JSON.parse(
                                localStorage.getItem(LS_IMAGES) || "{}"
                            );
                            imgs.flowerImg = imagePath;
                            localStorage.setItem(
                                LS_IMAGES,
                                JSON.stringify(imgs)
                            );
                            $("flowerTL").src = imagePath;
                            $("flowerBR").src = imagePath;
                            $("flowerTL").style.display = "block";
                            $("flowerBR").style.display = "block";
                            // Cập nhật trạng thái "đã chọn"
                            document
                                .querySelectorAll(".predefined-flower-img")
                                .forEach((img) => {
                                    img.style.border = "2px solid transparent";
                                });
                            btn.style.border = "2px solid var(--accent)";
                        });
                    });

                // download (safe)
                $("downloadBtn").addEventListener("click", async () => {
                    const btn = $("downloadBtn");
                    btn.disabled = true;
                    btn.textContent = "Đang tạo ảnh...";
                    try {
                        // wait images inside card to load (logo/flower/qr)
                        const imgs = Array.from(
                            document.querySelectorAll("#card img")
                        );
                        await Promise.all(
                            imgs.map(
                                (img) =>
                                    new Promise((resolve) => {
                                        if (!img.src) return resolve();
                                        if (img.complete) return resolve();
                                        img.onload = () => resolve();
                                        img.onerror = () => resolve();
                                    })
                            )
                        );

                        // compute safe scale: don't exceed 3 to avoid memory spikes
                        const card = $("card");
                        const origWidth = card.clientWidth || 360;
                        const targetWidth = 1080;
                        let scale = Math.min(
                            3,
                            Math.max(1.5, targetWidth / origWidth)
                        );
                        // render with html2canvas
                        const canvas = await html2canvas(card, {
                            useCORS: true,
                            scale: scale,
                            backgroundColor: null
                        });
                        // export via blob to avoid huge dataURL memory peak
                        canvas.toBlob(
                            (blob) => {
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement("a");
                                a.href = url;
                                a.download = `invoice_${
                                    $("orderId").value || "order"
                                }.png`;
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                setTimeout(
                                    () => URL.revokeObjectURL(url),
                                    10000
                                );
                            },
                            "image/png",
                            0.95
                        );
                    } catch (err) {
                        console.error(err);
                        alert("Có lỗi khi tạo ảnh. Thử lại nhé.");
                    } finally {
                        btn.disabled = false;
                        btn.textContent = "📥 Tải hóa đơn (PNG)";
                    }
                });
            }); // end DOMContentLoaded
        </script>
        <script>
    /* ======== Helpers ======== */
    const $ = (id) => document.getElementById(id);
    const LS_INVOICES = "invoice_v4_invoices";
    const LS_THEME = "invoice_v4_theme";

    function toCurrency(n) {
        return (Number(n) || 0).toLocaleString("vi-VN");
    }
    function dataURLFromFile(file) {
        return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload = (e) => res(e.target.result);
            r.onerror = rej;
            r.readAsDataURL(file);
        });
    }
    function escapeHtml(s) {
        return String(s || "").replace(
            /[&<>"']/g,
            (m) =>
                ({
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#39;"
                })[m]
        );
    }

    /* ======== Invoice Data Management ======== */
    function getInvoices() {
        try {
            return JSON.parse(localStorage.getItem(LS_INVOICES) || "[]");
        } catch (e) {
            console.error("Lỗi khi đọc hóa đơn từ localStorage:", e);
            return [];
        }
    }

    function saveInvoices(invoices) {
        localStorage.setItem(LS_INVOICES, JSON.stringify(invoices));
        renderInvoiceHistory();
    }

    function getFormData() {
        const formFields = [
            "shopName", "customerName", "customerPhone", "customerAddress",
            "orderDate", "expectedDate", "orderId", "paymentMethod",
            "shippingFee", "shortNote", "note", "thankYouText"
        ];
        const data = {};
        formFields.forEach((id) => (data[id] = $(id).value));
        return data;
    }

    function loadFormData(data) {
        const formFields = [
            "shopName", "customerName", "customerPhone", "customerAddress",
            "orderDate", "expectedDate", "orderId", "paymentMethod",
            "shippingFee", "shortNote", "note", "thankYouText"
        ];
        formFields.forEach((id) => {
            if ($(id)) $(id).value = data[id] || "";
        });
    }

    function getProducts() {
        const nodes = document.querySelectorAll(
            "#productList .product-item"
        );
        const arr = [];
        nodes.forEach((n) => {
            const name = n.querySelector(".productName").value.trim();
            const qty = Number(n.querySelector(".productQty").value) || 0;
            const price = Number(n.querySelector(".productPrice").value) || 0;
            if (name) arr.push({ name, qty, price });
        });
        return arr;
    }

    function setProducts(products) {
        const productListEl = $("productList");
        productListEl.innerHTML = "";
        products.forEach(p => addProduct(p));
    }

    async function saveCurrentInvoice() {
        const name = prompt("Nhập tên cho hóa đơn:");
        if (!name) return;

        const invoices = getInvoices();
        const newInvoice = {
            id: Date.now(),
            name: name,
            formData: getFormData(),
            products: getProducts(),
            images: JSON.parse(localStorage.getItem("invoice_v4_images") || "{}"),
            theme: localStorage.getItem(LS_THEME) || "theme-1",
            dateSaved: new Date().toISOString()
        };
        invoices.unshift(newInvoice);
        saveInvoices(invoices);
    }

    function loadInvoice(invoiceId) {
        const invoices = getInvoices();
        const invoice = invoices.find(inv => inv.id === invoiceId);
        if (!invoice) return alert("Không tìm thấy hóa đơn!");

        loadFormData(invoice.formData);
        setProducts(invoice.products);
        localStorage.setItem("invoice_v4_images", JSON.stringify(invoice.images));
        loadImages();
        setTheme(invoice.theme);

        debouncedUpdateInvoice();
        alert(`Đã tải hóa đơn "${invoice.name}".`);
    }

    function deleteInvoice(invoiceId) {
        if (!confirm("Bạn có chắc chắn muốn xóa hóa đơn này?")) return;
        const invoices = getInvoices().filter(inv => inv.id !== invoiceId);
        saveInvoices(invoices);
        alert("Đã xóa hóa đơn.");
    }

    function clearAllHistory() {
        if (!confirm("Bạn có chắc chắn muốn xóa TẤT CẢ hóa đơn đã lưu?")) return;
        saveInvoices([]);
        alert("Đã xóa toàn bộ lịch sử hóa đơn.");
    }
    
    function renderInvoiceHistory() {
        const listEl = $("invoiceHistoryList");
        const invoices = getInvoices();
        listEl.innerHTML = "";
        if (invoices.length === 0) {
            listEl.innerHTML = '<div style="text-align: center; color: var(--muted)">Chưa có hóa đơn nào được lưu.</div>';
            return;
        }

        invoices.forEach(inv => {
            const item = document.createElement("div");
            item.className = "history-list-item";
            item.innerHTML = `
                <div style="flex:1;">
                    <strong style="display:block">${escapeHtml(inv.name)}</strong>
                    <span class="small">${new Date(inv.dateSaved).toLocaleDateString()} - ${escapeHtml(inv.formData.customerName || "Khách hàng")}</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn ghost" onclick="loadInvoice(${inv.id})">Sửa</button>
                    <button class="btn warn" onclick="deleteInvoice(${inv.id})">Xóa</button>
                </div>
            `;
            listEl.appendChild(item);
        });
    }


    /* ======== Products (re-used) ======== */
    function createProductElement(p = {}) {
        const el = document.createElement("div");
        el.className = "product-item";
        el.innerHTML = `
            <input class="productName" placeholder="Tên sản phẩm" value="${escapeHtml(
                p.name || ""
            )}">
            <input class="productQty" placeholder="SL" type="number" min="0" value="${
                p.qty || ""
            }">
            <input class="productPrice" placeholder="Giá (VNĐ)" type="number" min="0" value="${
                p.price || ""
            }">
            <button class="remove-btn" title="Xóa">✕</button>
        `;
        el.querySelector(".remove-btn").addEventListener(
            "click",
            () => {
                el.remove();
                debouncedUpdateInvoice();
            }
        );
        el.querySelectorAll("input").forEach((i) =>
            i.addEventListener("input", debouncedUpdateInvoice)
        );
        return el;
    }

    function addProduct(p) {
        $("productList").appendChild(createProductElement(p || {}));
    }
    
    function clearProducts() {
        $("productList").innerHTML = "";
        debouncedUpdateInvoice();
    }

    /* ======== Images (re-used) ======== */
    async function handleImageUpload(inputId, outIds, storageKey) {
        const input = $(inputId);
        if (!input) return;
        input.addEventListener("change", async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const imgs = JSON.parse(
                localStorage.getItem("invoice_v4_images") || "{}"
            );
            imgs[storageKey] = await dataURLFromFile(f);
            localStorage.setItem("invoice_v4_images", JSON.stringify(imgs));
            loadImages();
        });
    }
    
    function loadImages() {
        const imgs = JSON.parse(
            localStorage.getItem("invoice_v4_images") || "{}"
        );
        if (!imgs) return;
        const images = {
            shopLogo: "outLogo",
            flowerImg: ["flowerTL", "flowerBR"],
            qrImg: "outQr",
        };
        for (const key in images) {
            const imgEl = $(images[key]);
            if (imgEl) {
                imgEl.src = imgs[key] || "";
                imgEl.style.display = imgs[key] ? "block" : "none";
            } else if (Array.isArray(images[key])) {
                images[key].forEach(id => {
                    const el = $(id);
                    if (el) {
                        el.src = imgs[key] || "";
                        el.style.display = imgs[key] ? "block" : "none";
                    }
                })
            }
        }
    }


    /* ======== Theme (re-used) ======== */
    function setTheme(cls) {
        document.body.classList.remove(
            "theme-1",
            "theme-2",
            "theme-3",
            "theme-4"
        );
        document.body.classList.add(cls);
        localStorage.setItem(LS_THEME, cls);
    }
    function loadTheme() {
        const t = localStorage.getItem(LS_THEME) || "theme-1";
        setTheme(t);
        document.querySelectorAll(".theme-btn").forEach((b) => {
            if (b.dataset.theme === t) b.classList.add("selected");
            else b.classList.remove("selected");
        });
    }

    /* ======== Debounced Update (re-used) ======== */
    let updateTimeout = null;
    function debouncedUpdateInvoice() {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            updateInvoice();
        }, 300);
    }

    /* ======== Update preview (re-used) ======== */
    function updateInvoice() {
        $("outShopName").innerText = $("shopName").value.trim() || "Diễm Thúy Shop";
        $("outCustomerName").innerText = $("customerName").value.trim() || "Tên khách hàng";
        $("outCustomerPhone").innerText = $("customerPhone").value.trim() || "SĐT";
        $("outCustomerAddress").innerText = $("customerAddress").value.trim() || "Địa chỉ nhận";
        $("outOrderDate").innerText = $("orderDate").value || "__/__/____";
        $("outExpectedDate").innerText = $("expectedDate").value || "__/__/____";
        $("outOrderId").innerText = $("orderId").value.trim() || "Mã đơn";
        $("outPaymentMethod").innerText = $("paymentMethod").value || "Tiền mặt";
        $("outShortNote").innerText = $("shortNote").value.trim() || "";
        $("outThank").innerText = $("thankYouText").value.trim() || "Cảm ơn anh/chị đã tin tưởng Diễm Thúy Shop!";

        const prods = getProducts();
        const out = $("outProducts");
        out.innerHTML = "";
        let total = 0;
        if (prods.length === 0) {
            out.innerHTML = '<div style="text-align:center;color:var(--muted);padding:8px">Không có sản phẩm</div>';
        } else {
            const frag = document.createDocumentFragment();
            prods.forEach((p) => {
                const subtotal = p.qty * p.price;
                total += subtotal;
                const row = document.createElement("div");
                row.className = "prod-row";
                row.innerHTML = `<div style="flex:1">${escapeHtml(p.name)}</div><div style="width:36px;text-align:center">${p.qty}</div><div style="width:90px;text-align:right">${toCurrency(p.price)} ₫</div><div style="width:110px;text-align:right">${toCurrency(subtotal)} ₫</div>`;
                frag.appendChild(row);
            });
            out.appendChild(frag);
        }
        const shipping = Number($("shippingFee").value) || 0;
        if (shipping > 0) {
            const r = document.createElement("div");
            r.className = "prod-row";
            r.innerHTML = `<div style="flex:1">Phí ship</div><div style="width:36px"></div><div style="width:90px;text-align:right"></div><div style="width:110px;text-align:right">${toCurrency(shipping)} ₫</div>`;
            out.appendChild(r);
            total += shipping;
        }
        $("outTotal").innerText = toCurrency(total) + " ₫";
    }

    /* ======== Initial load ======== */
    function loadLastSavedInvoiceOrDefaults() {
        const invoices = getInvoices();
        if (invoices.length > 0) {
            const latest = invoices[0];
            loadFormData(latest.formData);
            setProducts(latest.products);
            localStorage.setItem("invoice_v4_images", JSON.stringify(latest.images));
            loadImages();
            setTheme(latest.theme);
        } else {
            setProducts([{ name: "B.Begin Non-Alcohol Perfume", qty: 1, price: 1200000 }]);
            loadTheme();
            loadImages();
        }
        debouncedUpdateInvoice();
    }

    function resetFormToDefaults() {
        const inputs = document.querySelectorAll(
            '#invoiceForm input:not([type="file"]), #invoiceForm textarea, #invoiceForm select'
        );
        inputs.forEach(inp => {
            inp.value = "";
        });
        const initialProducts = [{ name: "B.Begin Non-Alcohol Perfume", qty: 1, price: 1200000 }];
        setProducts(initialProducts);
        localStorage.removeItem("invoice_v4_images");
        loadImages();
        loadTheme();
        debouncedUpdateInvoice();
    }


    /* ======== Events init ======== */
    document.addEventListener("DOMContentLoaded", () => {
        // load saved
        loadLastSavedInvoiceOrDefaults();
        renderInvoiceHistory();

        // input live update
        document
            .querySelectorAll(
                '#invoiceForm input:not([type="file"]), #invoiceForm textarea, #invoiceForm select'
            )
            .forEach((inp) =>
                inp.addEventListener("input", debouncedUpdateInvoice)
            );

        // file uploads (store base64)
        handleImageUpload("shopLogo", ["outLogo"], "shopLogo");
        handleImageUpload("flowerImage", ["flowerTL", "flowerBR"], "flowerImg");
        handleImageUpload("qrImage", ["outQr"], "qrImg");

        // add/clear product
        $("addProductBtn").addEventListener("click", () => {
            addProduct({});
            debouncedUpdateInvoice();
        });
        $("clearProducts").addEventListener("click", () => {
            if (confirm("Xóa hết sản phẩm?")) {
                clearProducts();
            }
        });

        // save/reset
        $("saveBtn").addEventListener("click", saveCurrentInvoice);
        $("resetBtn").addEventListener("click", () => {
            if (confirm("Reset form về mặc định?")) {
                resetFormToDefaults();
            }
        });
        $("clearAllHistoryBtn").addEventListener("click", clearAllHistory);


        // theme buttons
        document.querySelectorAll(".theme-btn").forEach((btn) =>
            btn.addEventListener("click", () => {
                setTheme(btn.dataset.theme);
                btn.classList.add("selected");
                document.querySelectorAll(".theme-btn").forEach((b) => {
                    if (b !== btn) b.classList.remove("selected");
                });
            })
        );

        // download (safe)
        $("downloadBtn").addEventListener("click", async () => {
            const btn = $("downloadBtn");
            btn.disabled = true;
            btn.textContent = "Đang tạo ảnh...";
            try {
                const imgs = Array.from(document.querySelectorAll("#card img"));
                await Promise.all(
                    imgs.map(
                        (img) =>
                            new Promise((resolve) => {
                                if (!img.src) return resolve();
                                if (img.complete) return resolve();
                                img.onload = () => resolve();
                                img.onerror = () => resolve();
                            })
                    )
                );
                const card = $("card");
                const origWidth = card.clientWidth || 360;
                const targetWidth = 1080;
                let scale = Math.min(3, Math.max(1.5, targetWidth / origWidth));
                const canvas = await html2canvas(card, {
                    useCORS: true,
                    scale: scale,
                    backgroundColor: null
                });
                canvas.toBlob(
                    (blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `invoice_${$("orderId").value || "order"}.png`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        setTimeout(() => URL.revokeObjectURL(url), 10000);
                    },
                    "image/png",
                    0.95
                );
            } catch (err) {
                console.error(err);
                alert("Có lỗi khi tạo ảnh. Thử lại nhé.");
            } finally {
                btn.disabled = false;
                btn.textContent = "📥 Tải hóa đơn (PNG)";
            }
        });
    }); // end DOMContentLoaded
</

    </body>
</html>
