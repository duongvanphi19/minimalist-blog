<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H√≥a ƒë∆°n kh√°ch h√†ng</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    select, input { padding: 5px; width: 300px; margin-top: 5px; }
</style>
</head>
<body>
<h2>Th√¥ng tin kh√°ch h√†ng</h2>

<form id="invoiceForm">

    <label for="customerName">T√™n kh√°ch h√†ng</label>
    <input type="text" id="customerName" name="customerName" required />

    <!-- Input ·∫©n ƒë·ªÉ l∆∞u ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß -->
    <input type="hidden" id="customerAddress" name="customerAddress" />

    <!-- Ph·∫ßn nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi -->
    <label for="province">T·ªânh/Th√†nh ph·ªë</label>
    <select id="province" required>
        <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
    </select>

    <label for="ward">X√£/Ph∆∞·ªùng</label>
    <select id="ward" required>
        <option value="">-- Ch·ªçn X√£/Ph∆∞·ªùng --</option>
    </select>

    <label for="street">S·ªë nh√†, t√™n ƒë∆∞·ªùng</label>
    <input type="text" id="street" placeholder="VD: 123 L√™ L·ª£i" required />

    <label for="customerPhone">S·ªë ƒëi·ªán tho·∫°i</label>
    <input type="tel" id="customerPhone" name="customerPhone" required />

    <button type="button" onclick="saveFormData()">üíæ L∆∞u h√≥a ƒë∆°n</button>
    <button type="button" onclick="loadFormData()">üìÇ T·∫£i h√≥a ƒë∆°n</button>

</form>

<script>
// ====== Load d·ªØ li·ªáu ƒë·ªãa ch·ªâ ======
let provinceList = [];

function loadProvinceData(callback) {
    fetch('data/data.json')
        .then(res => res.json())
        .then(data => {
            provinceList = data;
            const provinceSelect = document.getElementById('province');
            provinceSelect.innerHTML = '<option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>';
            data.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.province_code;
                opt.textContent = p.name;
                provinceSelect.appendChild(opt);
            });
            if (callback) callback();
        })
        .catch(err => console.error('Kh√¥ng th·ªÉ t·∫£i data/data.json', err));
}

// ====== C·∫≠p nh·∫≠t x√£/ph∆∞·ªùng khi ch·ªçn t·ªânh ======
document.getElementById('province').addEventListener('change', () => {
    const provinceCode = document.getElementById('province').value;
    const wardSelect = document.getElementById('ward');
    wardSelect.innerHTML = '<option value="">-- Ch·ªçn X√£/Ph∆∞·ªùng --</option>';

    const province = provinceList.find(p => p.province_code === provinceCode);
    if (province) {
        province.wards.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w.ward_code;
            opt.textContent = w.name;
            wardSelect.appendChild(opt);
        });
    }
    updateFullAddress();
});

// ====== C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß v√†o input ·∫©n ======
document.getElementById('ward').addEventListener('change', updateFullAddress);
document.getElementById('street').addEventListener('input', updateFullAddress);

function updateFullAddress() {
    const provinceName = document.querySelector('#province option:checked')?.textContent || '';
    const wardName = document.querySelector('#ward option:checked')?.textContent || '';
    const street = document.getElementById('street').value.trim();
    document.getElementById('customerAddress').value = `${street}, ${wardName}, ${provinceName}`;
}

// ====== L∆∞u d·ªØ li·ªáu h√≥a ƒë∆°n ======
function saveFormData() {
    updateFullAddress(); // ƒë·∫£m b·∫£o customerAddress ƒë√£ c·∫≠p nh·∫≠t
    const formData = {
        customerName: document.getElementById('customerName').value,
        customerAddress: document.getElementById('customerAddress').value,
        customerPhone: document.getElementById('customerPhone').value
    };
    localStorage.setItem('invoiceData', JSON.stringify(formData));
    alert('üíæ ƒê√£ l∆∞u h√≥a ƒë∆°n!');
}

// ====== T·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n ======
function loadFormData() {
    const saved = localStorage.getItem('invoiceData');
    if (!saved) {
        alert('‚ö†Ô∏è Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o ƒë∆∞·ª£c l∆∞u');
        return;
    }
    const data = JSON.parse(saved);

    document.getElementById('customerName').value = data.customerName || '';
    document.getElementById('customerPhone').value = data.customerPhone || '';
    document.getElementById('customerAddress').value = data.customerAddress || '';

    if (data.customerAddress) {
        const parts = data.customerAddress.split(',').map(s => s.trim());
        if (parts.length >= 3) {
            const street = parts[0];
            const wardName = parts[1];
            const provinceName = parts[2];
            document.getElementById('street').value = street;

            // Load dropdown v√† set gi√° tr·ªã
            loadProvinceData(() => {
                const provinceItem = provinceList.find(p => p.name === provinceName);
                if (provinceItem) {
                    document.getElementById('province').value = provinceItem.province_code;

                    // Load x√£/ph∆∞·ªùng
                    const wardSelect = document.getElementById('ward');
                    wardSelect.innerHTML = '<option value="">-- Ch·ªçn X√£/Ph∆∞·ªùng --</option>';
                    provinceItem.wards.forEach(w => {
                        const opt = document.createElement('option');
                        opt.value = w.ward_code;
                        opt.textContent = w.name;
                        wardSelect.appendChild(opt);
                    });

                    const wardItem = provinceItem.wards.find(w => w.name === wardName);
                    if (wardItem) {
                        document.getElementById('ward').value = wardItem.ward_code;
                    }
                }
            });
        }
    }
}

// Khi trang load xong -> load danh s√°ch t·ªânh
document.addEventListener('DOMContentLoaded', () => {
    loadProvinceData();
});
</script>

</body>
</html>