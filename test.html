<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <title>FAQs từ Google Sheets</title>
        <style>
            /* Định nghĩa biến CSS cho Clean & Functional Minimalism */
            :root {
                --primary-text-color: #333; /* Màu văn bản chính dịu hơn */
                --secondary-text-color: #555; /* Màu văn bản phụ */
                --background-color: #fff;
                --light-background-color: #f0f2f5; /* Nền nhẹ nhàng hơn */
                --border-color: #ddd; /* Viền mềm mại hơn */
                --accent-color: #007bff; /* Màu điểm nhấn: Xanh dương nhẹ nhàng */
                --accent-hover-color: #0056b3; /* Màu điểm nhấn khi hover */
                --highlight-color: #ffcc00; /* Giữ màu highlight tìm kiếm */
                --font-family-primary: "Inter", "Segoe UI", sans-serif;
                --border-radius-soft: 4px; /* Bo góc nhẹ */
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: var(--font-family-primary);
                background-color: var(--background-color);
                color: var(--primary-text-color);
                padding: 40px 20px;
                line-height: 1.6; /* Line height hơi giảm để gọn gàng hơn */
            }

            .container {
                max-width: 900px;
                margin: 0 auto;
            }

            h1 {
                font-size: 3rem; /* Giảm kích thước h1 một chút cho sự tinh tế */
                font-weight: 800; /* Vẫn đậm nhưng không quá "bold" */
                text-align: center;
                margin-bottom: 40px;
                color: var(--primary-text-color);
                letter-spacing: -0.02em; /* Giảm khoảng cách chữ */
            }

            .search-bar input {
                width: 100%;
                padding: 16px; /* Giảm padding một chút */
                font-size: 1.05rem;
                border: 1px solid var(--border-color); /* Viền mỏng hơn */
                border-radius: var(--border-radius-soft); /* Bo góc nhẹ */
                outline: none;
                background-color: var(--background-color);
                margin-bottom: 30px;
                font-weight: 500; /* Giảm độ đậm của font */
                color: var(--primary-text-color);
                box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Thêm box-shadow nhẹ */
                transition: border-color 0.2s ease, box-shadow 0.2s ease;
            }
            .search-bar input:focus {
                border-color: var(--accent-color); /* Viền màu điểm nhấn khi focus */
                box-shadow: 0 1px 6px rgba(0,0,0,0.12);
            }
            .search-bar input::placeholder {
                color: var(--secondary-text-color); /* Màu placeholder */
                font-weight: 500;
            }

            .chip {
                display: inline-block;
                padding: 10px 16px;
                margin: 6px 6px; /* Khoảng cách vừa phải */
                font-size: 0.9rem;
                font-weight: 600;
                border-radius: var(--border-radius-soft); /* Bo góc nhẹ */
                background-color: var(--light-background-color); /* Nền nhẹ hơn */
                color: var(--primary-text-color);
                border: 1px solid var(--border-color); /* Viền mềm mại hơn */
                cursor: pointer;
                transition: all 0.2s ease;
                text-transform: none; /* Bỏ uppercase */
            }

            .chip:hover {
                background-color: #e0e6eb; /* Màu hover nhẹ hơn */
                border-color: var(--accent-color);
                color: var(--primary-text-color);
            }

            .chip.active {
                background-color: var(--accent-color); /* Màu nền điểm nhấn khi active */
                color: var(--background-color); /* Chữ trắng */
                border-color: var(--accent-color);
            }

            .category h2 {
                font-size: 1.6rem; /* Giảm kích thước h2 một chút */
                font-weight: 700; /* Vẫn đậm */
                margin: 50px 0 20px; /* Khoảng cách vừa phải */
                padding-left: 0;
                border-left: none;
                color: var(--primary-text-color);
                text-transform: none; /* Bỏ uppercase */
                letter-spacing: -0.01em;
            }

            .faq-item {
                border-top: 1px solid var(--border-color); /* Viền mỏng và mềm */
                padding: 20px 0; /* Padding vừa phải */
                transition: background-color 0.3s ease;
            }
            .category .faq-item:last-child {
                border-bottom: 1px solid var(--border-color);
            }
            .faq-item:hover {
                background-color: var(--light-background-color); /* Highlight nhẹ khi hover */
            }

            .faq-question {
                font-size: 1.1rem; /* Kích thước font vừa phải */
                font-weight: 600; /* Vừa đủ đậm */
                cursor: pointer;
                display: flex;
                align-items: center;
                color: var(--primary-text-color);
                transition: color 0.3s ease;
            }

            .faq-question::before {
                content: "▶"; /* Biểu tượng vẫn rõ ràng */
                font-weight: bold;
                font-size: 1.2rem; /* Kích thước icon vừa phải */
                margin-right: 12px; /* Khoảng cách */
                color: var(--accent-color); /* Icon màu điểm nhấn */
                transition: transform 0.3s ease;
            }

            .faq-question.active::before {
                content: "▼";
                transform: rotate(0deg);
            }
            .faq-question.active {
                color: var(--accent-hover-color); /* Màu hơi đậm hơn khi active */
            }

            .faq-answer {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.4s ease-out;
                font-size: 0.95rem;
                color: var(--secondary-text-color);
                margin-top: 10px; /* Khoảng cách nhỏ hơn */
                padding-left: 28px; /* Căn chỉnh với câu hỏi */
            }

            .faq-answer p {
                margin-top: 10px;
            }

            .copy-btn,
            .reply-copy {
                font-size: 0.8rem;
                padding: 8px 14px;
                background: var(--accent-color); /* Màu điểm nhấn */
                color: var(--background-color);
                border: none;
                cursor: pointer;
                margin-top: 12px;
                transition: background 0.3s ease;
                font-weight: 600;
                text-transform: none; /* Bỏ uppercase */
                border-radius: var(--border-radius-soft); /* Bo góc nhẹ */
            }

            .copy-btn:hover,
            .reply-copy:hover {
                background: var(--accent-hover-color); /* Màu đậm hơn khi hover */
            }

            .scroll-top {
                position: fixed;
                bottom: 25px;
                right: 25px;
                background-color: var(--primary-text-color);
                color: var(--background-color);
                border: none;
                padding: 12px 16px; /* Kích thước vừa phải */
                font-size: 1.1rem;
                font-weight: 600;
                opacity: 0.9;
                cursor: pointer;
                display: none;
                border-radius: var(--border-radius-soft); /* Bo góc nhẹ */
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* Shadow rõ ràng hơn một chút */
            }

            .scroll-top.visible {
                display: block;
            }
            .scroll-top:hover {
                opacity: 1;
                background-color: var(--accent-hover-color); /* Màu accent khi hover */
            }


            .replies-container h2 {
                font-size: 1.6rem;
                font-weight: 700;
                margin: 50px 0 20px;
                color: var(--primary-text-color);
                text-transform: none;
                letter-spacing: -0.01em;
            }

            .reply-group {
                margin-bottom: 15px; /* Khoảng cách giữa các nhóm */
            }

            .reply-group h3 {
                font-size: 1.05rem;
                font-weight: 600;
                padding: 16px 20px;
                background: var(--light-background-color);
                color: var(--primary-text-color);
                cursor: pointer;
                position: relative;
                margin-bottom: 0;
                border: 1px solid var(--border-color);
                border-bottom: none;
                border-radius: var(--border-radius-soft) var(--border-radius-soft) 0 0; /* Bo góc trên */
                transition: background 0.2s ease, border-color 0.2s ease;
            }

            .reply-group h3:hover {
                background: #e0e6eb;
            }
            .reply-group h3.active {
                background-color: var(--accent-color); /* Nền màu accent khi active */
                color: var(--background-color); /* Chữ trắng */
                border-color: var(--accent-color);
            }

            .reply-group h3::after {
                content: "+";
                position: absolute;
                right: 20px;
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--accent-color); /* Icon màu điểm nhấn */
                transition: color 0.3s ease;
            }
            .reply-group h3.active::after {
                content: "−";
                color: var(--background-color); /* Icon trắng khi active */
            }


            .reply-items {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.4s ease-out;
                background: var(--background-color);
                padding: 0 20px;
                border: 1px solid var(--border-color);
                border-top: none;
                border-radius: 0 0 var(--border-radius-soft) var(--border-radius-soft); /* Bo góc dưới */
            }

            .reply-item {
                border-top: 1px dashed #eee; /* Viền nét đứt nhẹ nhàng */
                padding: 18px 0;
            }
            .reply-item:first-child {
                border-top: none;
            }


            .reply-text {
                font-size: 0.95rem;
                color: var(--secondary-text-color);
            }

            .highlight {
                background-color: var(--highlight-color);
                padding: 1px 0;
                border-radius: 2px; /* Highlight mềm mại hơn */
            }

            .error {
                color: var(--accent-color); /* Màu error là màu accent */
                text-align: center;
                margin-top: 20px;
                font-weight: 600;
            }

            .hidden {
                display: none !important;
            }

            /* Responsive */
            @media (max-width: 600px) {
                h1 {
                    font-size: 2.2rem;
                    margin-bottom: 25px;
                }

                .category h2 {
                    font-size: 1.4rem;
                    margin-top: 35px;
                }

                .faq-question {
                    font-size: 0.95rem;
                }

                .faq-question::before {
                    font-size: 1.1rem;
                    margin-right: 8px;
                }

                .faq-answer,
                .reply-text {
                    font-size: 0.88rem;
                    padding-left: 20px;
                }

                .chip {
                    font-size: 0.8rem;
                    padding: 7px 12px;
                    margin: 4px 4px;
                }

                .copy-btn,
                .reply-copy {
                    padding: 6px 10px;
                    font-size: 0.75rem;
                }

                .replies-container h2 {
                    font-size: 1.4rem;
                    margin-top: 35px;
                }

                .reply-group h3 {
                    font-size: 0.95rem;
                    padding: 12px 15px;
                }

                .reply-group h3::after {
                    font-size: 1.3rem;
                }

                .reply-items {
                    padding: 0 15px;
                }

                .scroll-top {
                    padding: 10px 14px;
                    font-size: 1rem;
                    bottom: 15px;
                    right: 15px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Câu Hỏi Thường Gặp</h1>
            <div class="search-bar">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Tìm kiếm câu hỏi..." />
            </div>
            <div class="chips" id="chips-container"></div>
            <div id="faq-container"></div>
            <div class="replies-container">
                <h2>Câu trả lời mẫu</h2>
                <div class="replies-list" id="replies-list"></div>
            </div>
            <div id="error-message" class="error"></div>
            <button id="scroll-top" class="scroll-top">🔝</button>
        </div>

        <script>
            const spreadsheetId =
                "1ZkmUGU8EzIKNAJ_-_zXTrZ2CyqzsE3GaDDzimwMhIPg";
            const apiKey = "AIzaSyB_3MXA6ysK_6OGSTKtnfwCfNTB8Ovpod8";
            const range = "FAQs!A2:C";
            let allFaqsData = []; // Biến toàn cục để lưu trữ tất cả dữ liệu FAQ ban đầu

            async function fetchSheetData() {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
                const errorMessage = document.getElementById("error-message");

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(
                            `Lỗi ${response.status}: ${errorData.error.message}`
                        );
                    }
                    const data = await response.json();
                    if (!data.values || data.values.length === 0) {
                        errorMessage.textContent =
                            "Không tìm thấy dữ liệu trong phạm vi FAQs!A2:C.";
                        return;
                    }
                    allFaqsData = data.values; // Lưu trữ dữ liệu gốc
                    renderFAQ(allFaqsData);
                    errorMessage.textContent = "";
                } catch (error) {
                    errorMessage.textContent = error.message;
                    console.error("Chi tiết lỗi:", error);
                }
            }

            function renderFAQ(values) {
                const faqContainer = document.getElementById("faq-container");
                const chipsContainer =
                    document.getElementById("chips-container");
                let categories = {};

                values.forEach(([category, question, answer]) => {
                    if (!categories[category]) categories[category] = [];
                    categories[category].push({ question, answer });
                });

                chipsContainer.innerHTML = ''; 

                const allChip = document.createElement("div");
                allChip.className = "chip all active";
                allChip.textContent = `Tất cả (${values.length})`;
                allChip.dataset.category = "all";
                chipsContainer.appendChild(allChip);

                for (const category of Object.keys(categories)) {
                    const chip = document.createElement("div");
                    chip.className = `chip ${category
                        .toLowerCase()
                        .replace(/\s+/g, "")}`;
                    chip.textContent = `${category} (${categories[category].length})`;
                    chip.dataset.category = category
                        .toLowerCase()
                        .replace(/\s+/g, "");
                    chipsContainer.appendChild(chip);
                }
                
                faqContainer.innerHTML = '';

                for (const [category, items] of Object.entries(categories)) {
                    const categoryDiv = document.createElement("div");
                    const categoryId = category.toLowerCase().replace(/\s+/g, "");
                    categoryDiv.className = `category ${categoryId}`;
                    categoryDiv.innerHTML = `<h2 id="${categoryId}">${category} (${items.length})</h2>`;

                    items.forEach((item) => {
                        const faqItem = document.createElement("div");
                        faqItem.className = "faq-item";
                        faqItem.innerHTML = `
                        <div class="faq-question">${item.question}</div>
                        <div class="faq-answer">
                            <p>${item.answer}</p>
                            <button class="copy-btn">Copy</button>
                        </div>
                    `;
                        categoryDiv.appendChild(faqItem);
                    });

                    faqContainer.appendChild(categoryDiv);
                }

                document.querySelectorAll(".faq-question").forEach((item) => {
                    item.addEventListener("click", () => {
                        const answer = item.nextElementSibling;
                        const isActive = item.classList.contains("active");
                        document
                            .querySelectorAll(".faq-question")
                            .forEach((q) => {
                                q.classList.remove("active");
                                q.nextElementSibling.style.maxHeight = null;
                            });
                        if (!isActive) {
                            item.classList.add("active");
                            answer.style.maxHeight = answer.scrollHeight + "px";
                        }
                    });
                });

                document.querySelectorAll(".copy-btn").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const answerText =
                            btn.previousElementSibling.textContent;
                        navigator.clipboard.writeText(answerText).then(() => {
                            btn.textContent = "Đã copy!";
                            setTimeout(() => (btn.textContent = "Copy"), 2000);
                        });
                    });
                });

                const searchInput = document.getElementById("searchInput");
                let searchTimeout;
                searchInput.addEventListener("input", () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const query = searchInput.value.toLowerCase();
                        let totalMatches = 0;

                        document.querySelectorAll(".faq-item").forEach((item) => {
                            const questionEl = item.querySelector(".faq-question");
                            const answerEl = item.querySelector(".faq-answer p");
                            const originalQuestion = questionEl.textContent; 
                            const originalAnswer = answerEl.textContent; 
                            const question = originalQuestion.toLowerCase();
                            const answer = originalAnswer.toLowerCase();
                            const isMatch =
                                question.includes(query) || answer.includes(query);

                            item.classList.toggle("hidden", !isMatch);
                            if (isMatch) totalMatches++;

                            questionEl.innerHTML = originalQuestion;
                            answerEl.innerHTML = originalAnswer;

                            if (query) {
                                questionEl.innerHTML =
                                    questionEl.textContent.replace(
                                        new RegExp(query, "gi"),
                                        (match) =>
                                            `<span class="highlight">${match}</span>`
                                    );
                                answerEl.innerHTML = answerEl.textContent.replace(
                                    new RegExp(query, "gi"),
                                    (match) =>
                                        `<span class="highlight">${match}</span>`
                                );
                            }
                        });

                        document.querySelectorAll(".category").forEach((category) => {
                            const items = category.querySelectorAll(
                                ".faq-item:not(.hidden)"
                            );
                            // Ẩn category nếu không có mục nào khớp VÀ có query tìm kiếm
                            category.classList.toggle("hidden", items.length === 0 && query !== '');
                        });
                        
                        updateCounts(); // Cập nhật số lượng dựa trên kết quả tìm kiếm
                    }, 300);
                });

                document.querySelectorAll(".chip").forEach((chip) => {
                    chip.addEventListener("click", () => {
                        document
                            .querySelectorAll(".chip")
                            .forEach((c) => c.classList.remove("active"));
                        chip.classList.add("active");
                        
                        const selectedCategory = chip.dataset.category;
                        
                        // Đảm bảo tất cả các FAQ và Categories được hiển thị lại
                        updateAllVisibility();
                        
                        // Xóa nội dung tìm kiếm và highlight
                        searchInput.value = '';
                        document.querySelectorAll('.highlight').forEach(span => {
                            span.outerHTML = span.innerHTML; 
                        });

                        if (selectedCategory === "all") {
                            window.scrollTo({ top: 0, behavior: "smooth" });
                        } else {
                            const targetCategoryElement = document.getElementById(selectedCategory);
                            if (targetCategoryElement) {
                                targetCategoryElement.scrollIntoView({ behavior: "smooth", block: "start" });
                            }
                        }
                        
                        updateCounts(); // Cập nhật lại số lượng sau khi chip được click
                    });
                });

                function updateAllVisibility() {
                    // Hiển thị tất cả categories và faq items
                    document.querySelectorAll(".category").forEach(category => {
                        category.classList.remove("hidden");
                        category.querySelectorAll(".faq-item").forEach(item => {
                            item.classList.remove("hidden");
                        });
                    });
                }

                function updateCounts() {
                    const query = searchInput.value.toLowerCase();
                    let totalVisibleFaqs = 0;

                    document.querySelectorAll(".category").forEach(category => {
                        const categoryName = category.querySelector("h2").textContent.split(" (")[0];
                        let count = 0;
                        if (query) { 
                            // Nếu có query tìm kiếm, đếm các mục không bị ẩn
                            count = category.querySelectorAll(".faq-item:not(.hidden)").length;
                        } else { 
                            // Nếu không có query, đếm tổng số mục ban đầu của category đó từ allFaqsData
                            count = allFaqsData.filter(faq => 
                                faq[0].toLowerCase().replace(/\s+/g, "") === category.id 
                            ).length;
                        }
                        category.querySelector("h2").textContent = `${categoryName} (${count})`;
                        totalVisibleFaqs += count;
                    });

                    document.querySelectorAll(".chip:not(.all)").forEach(chip => {
                        const categoryClass = chip.dataset.category;
                        // Lấy số lượng từ tiêu đề H2 tương ứng (đã được cập nhật bởi logic trên)
                        const matchingCategoryH2 = document.getElementById(categoryClass)?.querySelector("h2");
                        let count = 0;
                        if (matchingCategoryH2) {
                            const match = matchingCategoryH2.textContent.match(/\((\d+)\)/);
                            if (match && match[1]) {
                                count = parseInt(match[1]);
                            }
                        }
                        const chipText = chip.textContent.split(" (")[0];
                        chip.textContent = `${chipText} (${count})`;
                    });

                    const allChip = document.querySelector(".chip.all");
                    if (query) {
                        allChip.textContent = `Tất cả (${totalVisibleFaqs})`;
                    } else {
                         allChip.textContent = `Tất cả (${allFaqsData.length})`;
                    }
                }


                const scrollTopBtn = document.getElementById("scroll-top");
                window.addEventListener("scroll", () => {
                    scrollTopBtn.classList.toggle(
                        "visible",
                        window.scrollY > 200
                    );
                });
                scrollTopBtn.addEventListener("click", () => {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                });
            }
            async function fetchRepliesData() {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Replies!A1:A?key=${apiKey}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Lỗi ${response.status}`);
                    const data = await response.json();
                    if (data.values && data.values.length)
                        renderReplies(data.values);
                } catch (error) {
                    console.error("Lỗi fetch Replies:", error);
                }
            }

            function renderReplies(values) {
                const repliesList = document.getElementById("replies-list");
                repliesList.innerHTML = "";
                let currentGroup = null;
                let replies = [];

                values.forEach((row) => {
                    const text = row[0];
                    if (!text) return;

                    if (text.trim().startsWith("!")) {
                        if (currentGroup && replies.length) {
                            addRepliesGroup(
                                repliesList,
                                currentGroup.slice(1),
                                replies
                            );
                        }
                        currentGroup = text;
                        replies = [];
                    } else if (currentGroup) {
                        replies.push(text);
                    }
                });

                if (currentGroup && replies.length) {
                    addRepliesGroup(
                        repliesList,
                        currentGroup.slice(1),
                        replies
                    );
                }

                document
                    .querySelectorAll(".reply-group h3")
                    .forEach((header) => {
                        header.addEventListener("click", () => {
                            const items = header.nextElementSibling;
                            const isActive =
                                header.classList.contains("active");

                            document
                                .querySelectorAll(".reply-group h3")
                                .forEach((h) => {
                                    h.classList.remove("active");
                                    h.nextElementSibling.style.maxHeight = null;
                                });

                            if (!isActive) {
                                header.classList.add("active");
                                items.style.maxHeight =
                                    items.scrollHeight + "px";
                            }
                        });
                    });
            }

            function addRepliesGroup(container, title, replies) {
                const group = document.createElement("div");
                group.className = "reply-group";
                group.innerHTML = `<h3>${title}</h3><div class="reply-items"></div>`;

                const itemsContainer = group.querySelector(".reply-items");
                replies.forEach((reply) => {
                    const item = document.createElement("div");
                    item.className = "reply-item";
                    item.innerHTML = `
                    <span class="reply-text">${reply}</span>
                    <button class="reply-copy">Copy</button>
                `;
                    itemsContainer.appendChild(item);
                });

                container.appendChild(group);

                group.querySelectorAll(".reply-copy").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const text = btn.previousElementSibling.textContent;
                        navigator.clipboard.writeText(text).then(() => {
                            btn.textContent = "Đã copy!";
                            setTimeout(() => (btn.textContent = "Copy"), 2000);
                        });
                    });
                });
            }
            document.addEventListener("DOMContentLoaded", () => {
                fetchSheetData();
                fetchRepliesData();
            });
        </script>
    </body>
</html>
